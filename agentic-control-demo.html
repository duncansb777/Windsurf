<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Agentic Control Console Demo</title>
  <style>
    :root {
      --bg: #f6f7fb;
      --panel: #ffffff;
      --border: #e6e8f0;
      --text: #0b1020;
      --muted: #6b6f7b;
      --brand: #5f259f; /* DXC primary */
      --brand-dark: #4a1e7d;
      --ok: #10b981;
      --warn: #f59e0b;
      --err: #ef4444;
      --pill: #efe9fa;
    }
    * { box-sizing: border-box; }
    body { font-family: -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 0; background: var(--bg); color: var(--text); }
    header { position: sticky; top: 0; z-index: 50; display: flex; gap: 12px; justify-content: space-between; align-items: center; padding: 12px 16px; border-bottom: 1px solid var(--border); background: var(--panel); }
    .brand { display:flex; gap:10px; align-items:center; }
    .logo { width: 10px; height: 24px; background: linear-gradient(180deg, var(--brand), #8b5cf6); border-radius: 2px; }
    .env { display: flex; gap: 6px; align-items: center; }
    .env .chip { padding: 4px 8px; border: 1px solid var(--border); border-radius: 6px; background: #fafafa; cursor: pointer; font-size: 12px; }
    .env .chip.active { background: var(--brand); border-color: var(--brand); color: white; }

    #nav { display: flex; gap: 8px; }
    #nav button { border: 1px solid #d1d5db; padding: 10px 14px; cursor: pointer; background: #e5e7eb; border-radius: 10px; font-weight: 600; color: var(--brand); box-shadow: 0 1px 0 rgba(0,0,0,0.08); }
    #nav button.active { background: #d1d5db; color: var(--brand-dark); border-color: #cbd5e1; box-shadow: 0 2px 4px rgba(0,0,0,0.12); }

    main { padding: 16px; max-width: 1200px; margin: 0 auto; }
    .view { display: none; }
    .view.active { display: block; }
    .card { box-shadow: 0 6px 18px rgba(15, 23, 42, 0.06); border: 1px solid var(--border); border-radius: 12px; }
    .btn { transition: transform 0.02s ease-in, box-shadow 0.2s ease; }
    .btn:hover { box-shadow: 0 8px 18px rgba(0,0,0,0.08); }
    .btn:active { transform: translateY(1px); }

    .grid { display: grid; gap: 16px; }
    .link-cell { color: var(--brand); cursor: pointer; text-decoration: underline; }
    .focus-glow { box-shadow: 0 0 0 3px rgba(95,37,159,0.25) !important; transition: box-shadow 0.3s ease; }
    .hl { background: var(--pill); color: var(--brand-dark); padding: 0 3px; border-radius: 3px; }

    .metrics { display: grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap: 12px; margin-bottom: 16px; }
    .card { border: 1px solid var(--border); border-radius: 12px; padding: 12px; background: var(--panel); box-shadow: 0 1px 0 rgba(0,0,0,0.02); }
    .card h3, .card h4 { margin: 0 0 8px 0; }

    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px; border-bottom: 1px solid var(--border); font-size: 14px; }
    th { text-align: left; color: var(--muted); font-weight: 600; }

    .pill { display: inline-block; padding: 2px 10px; border-radius: 999px; font-size: 12px; background: #eef2ff; color: #3730a3; border: 1px solid #e0e7ff; }
    .pill.ok { background: #ecfdf5; color: #065f46; border-color: #d1fae5; }
    .pill.warn { background: #fffbeb; color: #854d0e; border-color: #fde68a; }
    .pill.err { background: #fef2f2; color: #991b1b; border-color: #fecaca; }

    .btn { border: 1px solid var(--brand); background: var(--brand); color: white; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-weight: 600; }
    .btn.primary { background: var(--brand-dark); border-color: var(--brand-dark); color: white; }
    .btn.ghost { background: transparent; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }

    textarea, select, input[type="text"] { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; background: white; font-family: inherit; resize: vertical; }
    label { font-size: 12px; color: var(--muted); display: block; margin-bottom: 6px; }

    .split { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }

    /* Tabs */
    .tabs { display: flex; gap: 6px; border-bottom: 1px solid var(--border); margin-bottom: 12px; }
    .tab { padding: 8px 12px; border: 1px solid var(--border); background: #fff; border-bottom: none; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: 600; color: #374151; }
    .tab.active { background: var(--brand); color: white; border-color: var(--brand); }
    .tabpanes > .tabpane { display: none; }
    .tabpanes > .tabpane.active { display: block; }

    /* Modal */
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.35); display: none; align-items: center; justify-content: center; z-index: 100; }
    .modal { width: min(680px, 94vw); background: white; border: 1px solid var(--border); border-radius: 12px; padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
    .modal header { position: relative; border-bottom: 1px solid var(--border); margin: -16px -16px 12px; padding: 12px 16px; }
    .modal footer { display: flex; justify-content: flex-end; gap: 8px; margin-top: 12px; }

    /* Toast */
    .toast { position: fixed; bottom: 16px; right: 16px; background: #111827; color: white; padding: 10px 12px; border-radius: 8px; display: none; z-index: 200; box-shadow: 0 6px 20px rgba(0,0,0,0.2); }

    /* Footer actions */
    .footer-actions { position: sticky; bottom: 0; display: flex; justify-content: flex-end; gap: 8px; padding: 10px; background: linear-gradient(180deg, rgba(247,247,249,0), rgba(247,247,249,1)); border-top: 1px solid var(--border); margin-top: 8px; }

    @media (max-width: 900px) {
      .metrics { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .split { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo"></div>
      <div><strong>Agentic Control Console</strong></div>
    </div>

  <!-- Fleet Quick Run Modal -->
  <div id="quickRunModal" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <header class="row" style="justify-content: space-between;">
        <strong>Run Health Flow</strong>
        <button class="btn" onclick="closeModal('quickRunModal')">Close</button>
      </header>
      <div>
        <label>Select Patient</label>
        <select id="fleet_patient_sel">
          <option value="">Select patient…</option>
        </select>
      </div>
      <footer>
        <button class="btn" onclick="closeModal('quickRunModal')">Cancel</button>
        <button class="btn primary" onclick="runQuickDischargeFlow()">Run Discharge + Agentic Referral</button>
      </footer>
    </div>
  </div>

  <!-- Follow-Up Booking Modal (Step 3) -->
  <div id="followupBookingModal" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <header class="row" style="justify-content: space-between;">
        <strong>Book Follow-Up Appointments</strong>
        <button class="btn" onclick="closeModal('followupBookingModal')">Close</button>
      </header>
      <div id="followupBookingBody" style="max-height:60vh; overflow:auto; padding-top:8px;"></div>
      <footer>
        <button class="btn" onclick="closeModal('followupBookingModal')">Cancel</button>
        <button class="btn primary" onclick="confirmFollowupBookings()">Confirm Bookings</button>
      </footer>
    </div>
  </div>
    <div id="nav">
      <button class="btn" data-view="fleet">Fleet</button>
      <button class="btn" data-view="escalations">Escalations</button>
      <button class="btn" data-view="agent">Agent Detail</button>
      <button class="btn" data-view="studio">Prompt Studio</button>
      <button class="btn" data-view="billing">Billing Agents</button>
      <button class="btn" data-view="eval">Eval & Rollout</button>
      <button class="btn" data-view="healthAgents">Health Agents</button>
    </div>
    <div class="env">
      <span style="color:var(--muted); font-weight:600;">Env</span>
      <div class="chip active" data-env="Prod">Prod</div>
      <div class="chip" data-env="UAT">UAT</div>
      <div class="chip" data-env="Sandbox">Sandbox</div>
      <div id="llmDot" style="width:12px; height:12px; background:#ddd; border-radius:999px; margin-left:8px; border:2px solid #d1d5db;"></div>
      <span id="llmStatus" style="margin-left:12px; font-size:12px; color:var(--muted);">LLM: loading…</span>
    </div>
  </header>

  <main>
    <!-- Screen 1: Fleet Dashboard -->
    <section id="fleet" class="view active">
      <div class="row" style="justify-content: space-between;">
        <h2 style="margin:8px 0;">Fleet Dashboard</h2>
        <div class="row">
          <button class="btn" onclick="goToView('escalations')">View Escalations</button>
          <button class="btn" onclick="goToView('studio')">Open Prompt Studio</button>
          <button class="btn" onclick="showToast('Opening Health & Telemetry…')">Health & Telemetry</button>
        </div>
      </div>

      <div class="metrics">
        <div class="card"><div style="color:var(--muted); font-weight:600;">Active Agents</div><div style="font-size:28px; font-weight:800;">74</div></div>
        <div class="card"><div style="color:var(--muted); font-weight:600;">Tasks In Flight</div><div style="font-size:28px; font-weight:800;">312</div></div>
        <div class="card"><div style="color:var(--muted); font-weight:600;">Escalations (Last Hour)</div><div style="font-size:28px; font-weight:800;">9</div></div>
        <div class="card"><div style="color:var(--muted); font-weight:600;">Error Rate</div><div style="font-size:28px; font-weight:800;">0.8%</div></div>
      </div>

      <div class="row" style="margin-bottom:8px;">
        <div class="pill">Billing</div>
        <div class="pill">Field Ops</div>
        <div class="pill">ERP</div>
        <div class="pill">Claims</div>
      </div>

      <div class="card">
        <h3>Billing Agents</h3>
        <table>
          <thead>
            <tr><th>Agent</th><th>Status</th><th>Autonomy</th><th>Current Tasks</th><th></th></tr>
          </thead>
          <tbody>
            <tr>
              <td>Balance Transfer Agent</td>
              <td><span class="pill ok">Healthy</span></td>
              <td>2</td>
              <td>38</td>
              <td class="row" style="gap:6px;">
                <button class="btn" onclick="goToAgent('Balance Transfer Agent')">View</button>
                <button class="btn" onclick="executeAgent('Balance Transfer Agent')">Run</button>
                <button class="btn" onclick="window.open(agentExecUrl('Balance Transfer Agent'),'_blank')">Open Link</button>
              </td>
            </tr>
            <tr>
              <td>Ownership Trigger Agent</td>
              <td><span class="pill warn">Degraded</span></td>
              <td>1</td>
              <td>22</td>
              <td class="row" style="gap:6px;">
                <button class="btn" onclick="goToAgent('Ownership Trigger Agent')">View</button>
                <button class="btn" onclick="executeAgent('Ownership Trigger Agent')">Run</button>
                <button class="btn" onclick="window.open(agentExecUrl('Ownership Trigger Agent'),'_blank')">Open Link</button>
              </td>
            </tr>
            <tr>
              <td>Special Read Scheduler Agent</td>
              <td><span class="pill">Paused</span></td>
              <td>0</td>
              <td>0</td>
              <td class="row" style="gap:6px;">
                <button class="btn" onclick="goToAgent('Special Read Scheduler Agent')">View</button>
                <button class="btn" onclick="executeAgent('Special Read Scheduler Agent')">Run</button>
                <button class="btn" onclick="window.open(agentExecUrl('Special Read Scheduler Agent'),'_blank')">Open Link</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="card">
        <h3>Health Agents</h3>
        <p style="color:var(--muted); margin-top:-4px; font-size:12px;">Hospital Discharge bundle (6 agents) orchestrated through the Health screen.</p>
        <table>
          <thead>
            <tr><th>Agent / Step</th><th>Status</th><th>Risk Focus</th><th></th></tr>
          </thead>
          <tbody>
            <tr>
              <td>Discharge Readiness &amp; Risk</td>
              <td><span class="pill ok">Healthy</span></td>
              <td>Risk banding (LACE+ / HOSPITAL)</td>
              <td class="row" style="gap:6px;">
                <button class="btn" onclick="goToView('healthAgents'); selectHdPatient && selectHdPatient('P0001');">Open Panel</button>
              </td>
            </tr>
            <tr>
              <td>Medication Reconciliation &amp; Education</td>
              <td><span class="pill ok">Healthy</span></td>
              <td>High-risk meds &amp; education</td>
              <td class="row" style="gap:6px;">
                <button class="btn" onclick="goToView('healthAgents'); selectHdPatient && selectHdPatient('P0001');">Open Panel</button>
              </td>
            </tr>
            <tr>
              <td>Follow-Up Orchestration</td>
              <td><span class="pill ok">Healthy</span></td>
              <td>GP &amp; specialist follow-up</td>
              <td class="row" style="gap:6px;">
                <button class="btn" onclick="goToView('healthAgents'); selectHdPatient && selectHdPatient('P0001');">Open Panel</button>
              </td>
            </tr>
            <tr>
              <td>GP &amp; Community Handoff</td>
              <td><span class="pill ok">Healthy</span></td>
              <td>GP summary + community services</td>
              <td class="row" style="gap:6px;">
                <button class="btn" onclick="goToView('healthAgents'); selectHdPatient && selectHdPatient('P0001');">Open Panel</button>
              </td>
            </tr>
            <tr>
              <td>Post-Discharge Monitoring</td>
              <td><span class="pill ok">Healthy</span></td>
              <td>Avatar check-ins &amp; alerts</td>
              <td class="row" style="gap:6px;">
                <button class="btn" onclick="goToView('healthAgents'); selectHdPatient && selectHdPatient('P0001');">Open Panel</button>
              </td>
            </tr>
            <tr>
              <td>Outcomes &amp; Learning</td>
              <td><span class="pill ok">Healthy</span></td>
              <td>Readmission &amp; LOS KPIs</td>
              <td class="row" style="gap:6px;">
                <button class="btn" onclick="goToView('healthAgents'); selectHdPatient && selectHdPatient('P0001');">Open Panel</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

    </section>

  <!-- Billing Agents (Meter Read) -->
  <section id="billing" class="view">
    <h2 style="margin:8px 0;">Billing Agents</h2>
    <div class="grid">
      <div class="card">
        <h3>Meter Read Agent</h3>
        <p style="color:var(--muted);">Upload a CSV of meter reads to process and validate. You can download a sample file.</p>
        <div class="row" style="gap:8px; align-items: center;">
          <button class="btn" onclick="downloadMeterSample()">Download Sample CSV</button>
          <input type="file" id="meterFile" accept=".csv,text/csv" />
          <button class="btn primary" onclick="uploadMeterReads()">Upload & Process</button>
        </div>
      </div>
      <div class="card">
        <h3>Result</h3>
        <pre id="meter_result_json" style="white-space:pre-wrap; overflow:auto; max-height:40vh; background:#0b1020; color:#c7e1ff; padding:12px; border-radius:8px;"></pre>
      </div>
    </div>

    <div class="grid" style="margin-top:12px;">
      <div class="card">
        <h3>CoO / Billing Flows (Embedded)</h3>
        <p style="color:var(--muted);">Run Change-of-Ownership and billing flows directly against the shared CSV data (mock MCP view).</p>
        <div class="row" style="gap:8px; flex-wrap:wrap; margin-bottom:8px;">
          <button class="btn" onclick="runCooFlow('address-standardize')">Address Standardize</button>
          <button class="btn" onclick="runCooFlow('ownership')">Ownership (LLM Route)</button>
          <button class="btn" onclick="runCooFlow('ownership-deterministic')">Ownership (Deterministic)</button>
          <button class="btn" onclick="runCooFlow('special-read')">Special Read Scheduler</button>
          <button class="btn" onclick="runCooFlow('bill-transfer')">Bill Transfer</button>
          <button class="btn" onclick="runCooFlow('reset')">Reset CoO Demo</button>
        </div>
      </div>
      <div class="card">
        <h3>CoO Result (JSON + Artifacts)</h3>
        <pre id="coo_result_json" style="white-space:pre-wrap; overflow:auto; max-height:40vh; background:#0b1020; color:#c7e1ff; padding:12px; border-radius:8px;"></pre>
      </div>
      <div class="card">
        <h3>CoO Result (Natural Language)</h3>
        <div id="coo_result_text" style="padding:12px; line-height:1.5; color:#1f2937;"></div>
      </div>
    </div>

    <div class="grid" style="margin-top:12px;">
      <div class="card" style="grid-column: span 3;">
        <h3>GenAI Hub</h3>
        <p style="color:var(--muted); margin-top:-4px;">Open the external DXC GenAI Hub experience in your default browser.</p>
        <button class="btn" onclick="loadGenAIHub()">Open GenAI Hub</button>
      </div>
    </div>
  </section>

  <!-- Health Agents (actions) -->
  <section id="healthAgents" class="view">
    <h2 style="margin:8px 0;">Health Agents</h2>
    <p style="color:var(--muted); margin-top:-8px;">Hospital Discharge agents and prompts powered by the Prompt Studio configuration.</p>

    <div class="card" style="margin-top:8px;">
      <div class="row" style="justify-content: space-between; align-items: center; margin-bottom:8px;">
        <h3 style="margin:0;">Hospital Discharge Coordination</h3>
        <span style="font-size:12px; color:var(--muted);">Demo panel using mock inpatient + risk data (LACE+ / HOSPITAL).</span>
      </div>
      <div class="metrics" id="hd_kpi_strip" style="margin-bottom:12px;"></div>
      <div class="split">
        <div>
          <h4 style="margin:4px 0 8px;">Inpatients &amp; Risk</h4>
          <div class="card" style="padding:0; box-shadow:none;">
            <table>
              <thead>
                <tr>
                  <th>Patient</th>
                  <th>Ward / Service</th>
                  <th>LACE+</th>
                  <th>HOSPITAL</th>
                  <th>Risk</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="hd_inpatient_tbody"></tbody>
            </table>
          </div>
        </div>
        <div>
          <h4 style="margin:4px 0 8px;">Discharge Bundle (Selected Patient)</h4>
          <div id="hd_selected_patient" style="font-size:13px; color:var(--muted); margin-bottom:4px;">Select a patient to view their 6-step discharge bundle.</div>
          <div class="grid" style="grid-template-columns:1fr; gap:8px;" id="hd_step_cards"></div>
        </div>
      </div>
      <div style="margin-top:12px;">
        <h4 style="margin:4px 0 6px;">LLM Decision Logic (Demo)</h4>
        <p style="color:var(--muted); font-size:12px; margin-top:-4px;">When you run a Hospital Discharge step, this shows the reasoning the LLM agent used based on the CSV-backed patient and risk data.</p>
        <div id="hd_llm_logic" style="white-space:pre-wrap; font-size:12px; color:var(--muted); padding:8px; background:#f9fafb; border-radius:8px; border:1px solid var(--border);"></div>
        <div style="margin-top:8px;">
          <h4 style="margin:4px 0 6px;">Health Agent Result</h4>
          <div class="split" style="gap:8px;">
            <pre id="ha_result_json" style="white-space:pre-wrap; overflow:auto; max-height:30vh; background:#0b1020; color:#c7e1ff; padding:8px; border-radius:8px;"></pre>
            <div id="ha_result_text" style="font-size:13px; line-height:1.5; color:#1f2937;"></div>
          </div>
        </div>
      </div>
    </div>
  </section>

    <!-- Screen 2: Escalations Inbox -->
    <section id="escalations" class="view">
      <div class="row" style="justify-content: space-between;">
        <h2 style="margin:8px 0;">Escalations</h2>
        <div class="row">
          <select id="filterSeverity">
            <option>Severity: All</option>
            <option>Severity: High</option>
            <option>Severity: Medium</option>
            <option>Severity: Low</option>
          </select>
          <select id="filterProcess">
            <option>Process: All</option>
            <option>Process: CoO</option>
            <option>Process: Meter Read</option>
          </select>
          <select id="filterAgent">
            <option>Agent: All</option>
            <option>Balance Transfer Agent</option>
            <option>Ownership Trigger Agent</option>
          </select>
        </div>
      </div>

      <div class="grid">
        <div class="card">
          <div class="row" style="justify-content: space-between;">
            <div><strong>High • Change of Ownership • Balance Transfer Agent</strong></div>
            <div style="color: var(--muted);">2 mins ago</div>
          </div>
          <p>Agent recommends disconnecting service for account #134593 – low confidence.</p>
          <div class="row" style="justify-content: space-between;">
            <div style="color: var(--muted);">Confidence: 54%</div>
            <div class="row">
              <button class="btn primary" onclick="openReview()">Review</button>
              <button class="btn" disabled>Auto-approve Next Time</button>
              <button class="btn" onclick="goToAgentWithCase()">Teach Agent</button>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="row" style="justify-content: space-between;">
            <div><strong>Medium • Meter Read • Ownership Trigger Agent</strong></div>
            <div style="color: var(--muted);">8 mins ago</div>
          </div>
          <p>Clarification requested on estimated read variance for NMI 70011233.</p>
          <div class="row" style="justify-content: space-between;">
            <div style="color: var(--muted);">Confidence: 68%</div>
            <div class="row">
              <button class="btn" onclick="openReview('Clarification requested…')">Review</button>
              <button class="btn" disabled>Auto-approve Next Time</button>
              <button class="btn" onclick="goToAgent('Ownership Trigger Agent')">Teach Agent</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Screen 3: Agent Detail (Behaviour / Prompts default) -->
    <section id="agent" class="view">
      <div class="row" style="justify-content: space-between;">
        <div>
          <h2 style="margin: 0 0 4px;" id="agentTitle">Balance Transfer Agent</h2>
          <div class="row" style="align-items:center; gap:8px; color: var(--muted);">
            <span id="agentSubtitle">Billing Domain • Change of Ownership</span>
            <select id="agentDomain" style="margin-left:8px;">
              <option value="billing">Billing Agents</option>
              <option value="health">Health Agents</option>
            </select>
          </div>
        </div>
        <div class="row">
          <span class="pill ok">Healthy</span>
          <div class="row" style="gap:4px;">
            <span style="color:var(--muted);">Autonomy</span>
            <input id="autonomy" type="range" min="0" max="3" value="2" />
            <span id="autonomyVal" style="font-weight:700;">2</span>
          </div>
          <button class="btn" onclick="showToast('Agent paused')">Pause</button>
        </div>
      </div>

      <div class="tabs" data-tabs="agent-tabs">
        <div class="tab">Overview</div>
        <div class="tab">Activity</div>
        <div class="tab active">Behaviour (Prompts)</div>
        <div class="tab">Evals</div>
      </div>

      <div class="tabpanes" data-tabpanes="agent-tabs">
        <div class="tabpane">Overview content (placeholder for demo)</div>
        <div class="tabpane">Recent activity (placeholder for demo)</div>
        <div class="tabpane active">
          <div class="split">
            <div>
              <div class="card">
                <h3>Prompt Layers</h3>
                <div style="display:grid; gap:12px;">
                  <div>
                    <label>System Prompt (read-only)</label>
                    <textarea readonly style="background:#f9fafb; color:#6b7280; height:100px;">You are a reliable agent for SA Water billing operations. Follow policies and ensure customer protections.</textarea>
                  </div>
                  <div>
                    <label>Domain Prompt (Billing)</label>
                    <textarea id="domainPrompt" style="height:120px;">Billing domain norms: apply hardship and vulnerable-customer protections prioritising continuity of service.</textarea>
                    <div class="row" style="justify-content:flex-end; margin-top:6px;">
                      <button class="btn" onclick="openEdit('Domain Prompt (Billing)', 'domainPrompt')">Edit</button>
                    </div>
                  </div>
                  <div>
                    <label>Process Prompt (Change of Ownership)</label>
                    <textarea id="processPrompt" style="height:120px;">When handling Change of Ownership, ensure balances are transferred fairly, avoiding wrongful disconnections where payment plans exist.</textarea>
                    <div class="row" style="justify-content:flex-end; margin-top:6px;">
                      <button class="btn" onclick="openEdit('Process Prompt (Change of Ownership)', 'processPrompt')">Edit</button>
                    </div>
                  </div>
                  <div>
                    <label>Environment Overrides (<span id="envLabel">Prod</span>)</label>
                    <textarea id="envOverrides" style="height:100px;">Prod-only guardrails enabled. Log all disconnection intents for manual review.</textarea>
                    <div class="row" style="justify-content:flex-end; margin-top:6px;">
                      <button class="btn" onclick="openEdit('Environment Overrides', 'envOverrides')">Edit</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div>
              <div class="card">
                <h3>Examples & Corrections</h3>
                <div style="margin-bottom:8px;">
                  <label>Scenario</label>
                  <select id="scenarioSelect">
                    <option>Disconnection with Active Payment Plan</option>
                    <option>Final Bill with Credit Balance</option>
                    <option>Move-In with Pending Special Read</option>
                  </select>
                </div>
                <div class="grid">
                  <div>
                    <label>Agent’s Previous Behaviour</label>
                    <textarea readonly style="height:80px; background:#f9fafb; color:#6b7280;">Recommended disconnection despite active payment plan (low confidence).</textarea>
                  </div>
                  <div>
                    <label>Desired Behaviour</label>
                    <textarea id="desiredBehaviour" style="height:100px;">Keep service connected, notify customer, and schedule follow-up; never disconnect vulnerable customers.</textarea>
                  </div>
                </div>
                <div class="row" style="justify-content:flex-end; margin-top:8px;">
                  <button class="btn" onclick="showToast('Example added to training set')">Add as Training Example</button>
                </div>
              </div>
              <div class="card">
                <h3>Actions</h3>
                <div class="row">
                  <button class="btn" onclick="executeCurrentAgent()">Run Agent</button>
                  <button class="btn" onclick="openCurrentAgentLink()">Open Link</button>
                  <button class="btn" onclick="goToView('eval'); seedEval('agent')">Run Eval Suite</button>
                  <button class="btn" onclick="goToView('eval'); seedEval('propose')">Propose New Version</button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="tabpane">Evals (placeholder for demo)</div>
      </div>
    </section>

    <!-- Screen 4: Prompt Studio -->
    <section id="studio" class="view">
      <h2 style="margin:8px 0;">Prompt Studio</h2>
      <div class="split">
        <aside>
          <div class="card">
            <label for="studioDomain" style="font-size:12px; color:var(--muted);">Domain</label>
            <select id="studioDomain" style="width:100%; margin-bottom:8px;">
              <option value="water">Water Utility Agents</option>
              <option value="health">Health Agents</option>
            </select>
            <h4>Prompt Packs</h4>
            <ul id="packList" style="list-style:none; padding:0; margin:0; display:grid; gap:6px;">
              <li><button class="btn" data-pack="SA Water – CoO Core v1.3" data-domain="water">SA Water – CoO Core v1.3</button></li>
              <li><button class="btn" data-pack="SA Water – Vulnerable Customer Handling v1.1" data-domain="water">SA Water – Vulnerable Customer Handling v1.1</button></li>
              <li><button class="btn" data-pack="GWW – Grange Billing Twin v0.9" data-domain="water">GWW – Grange Billing Twin v0.9</button></li>
              <li><button class="btn" data-pack="Australian Health Privacy Regulations" data-domain="health">Australian Health Privacy Regulations</button></li>
              <li><button class="btn" data-pack="Patient Discharge Process" data-domain="health">Patient Discharge Process</button></li>
              <li><button class="btn" data-pack="Hospital – Discharge Readiness & Risk Agent" data-domain="health">Hospital – Discharge Readiness &amp; Risk</button></li>
              <li><button class="btn" data-pack="Hospital – Medication Reconciliation Agent" data-domain="health">Hospital – Med Reconciliation</button></li>
              <li><button class="btn" data-pack="Hospital – Follow-Up Orchestration Agent" data-domain="health">Hospital – Follow-Up Orchestration</button></li>
              <li><button class="btn" data-pack="Hospital – GP &amp; Community Handoff Agent" data-domain="health">Hospital – GP &amp; Community Handoff</button></li>
              <li><button class="btn" data-pack="Hospital – Post-Discharge Monitoring Agent" data-domain="health">Hospital – Post-Discharge Monitoring</button></li>
              <li><button class="btn" data-pack="Hospital – Outcomes &amp; Governance Analytics Agent" data-domain="health">Hospital – Outcomes &amp; Governance</button></li>
            </ul>
          </div>
        </aside>
        <section>
          <div class="card">
            <h3 id="packTitle">SA Water – Vulnerable Customer Handling v1.1</h3>
            <p id="packDesc" style="color:var(--muted);">Guidance to protect vulnerable customers during billing and change-of-ownership flows.</p>
            <p style="margin-top:-6px;"><strong>Affects:</strong> <span id="packAffects">Balance Transfer Agent • Ownership Trigger Agent • Special Read Scheduler Agent</span></p>

            <div class="tabs" data-tabs="studio-tabs">
              <div class="tab active">Instructions</div>
              <div class="tab">Examples</div>
              <div class="tab">Policies</div>
              <div class="tab">Context</div>
            </div>
            <div class="tabpanes" data-tabpanes="studio-tabs">
              <div class="tabpane active">
                <label>Consolidated Instructions</label>
                <textarea id="packInstructions" style="height:160px;">Core behaviour for handling vulnerable customers. Always prefer continuity of service, apply hardship policies, and escalate human review for any disconnection intent.</textarea>
                <div class="footer-actions">
                  <button class="btn" onclick="openEdit('Edit Instructions', 'packInstructions')">Edit</button>
                  <button class="btn" onclick="showToast('Prompt pack draft saved')">Save Draft</button>
                  <button class="btn" onclick="goToView('eval'); seedEval('pack')">Run Regression Tests</button>
                  <button class="btn primary" onclick="goToView('eval'); seedEval('propose-pack')">Propose for Deployment</button>
                </div>
              </div>
              <div class="tabpane">
                <div class="row" style="justify-content: space-between;">
                  <h4 style="margin:8px 0;">Examples</h4>
                  <button class="btn" onclick="openAddExample()">Add Example from Escalation</button>
                </div>
                <table>
                  <thead>
                    <tr><th>Scenario</th><th>Status</th><th>Last Run</th></tr>
                  </thead>
                  <tbody id="packExamplesBody">
                    <tr><td>Disconnection with Active Payment Plan</td><td><span class="pill ok">Passed</span></td><td>Today</td></tr>
                    <tr><td>Final Bill with Credit Balance</td><td><span class="pill ok">Passed</span></td><td>Today</td></tr>
                    <tr><td>Move-In with Pending Special Read</td><td><span class="pill ok">Passed</span></td><td>Today</td></tr>
                  </tbody>
                </table>
              </div>
              <div class="tabpane">
                <h4>Policies</h4>
                <textarea id="policyText" style="width:100%; min-height:180px; font-family:inherit;">
- Never disconnect vulnerable customers without human approval.
- Always respect active payment plans.
- Log and justify any service interruption intent.
- Apply Australian health privacy regulations (APP 6/11, state Health Records Acts) to all use of clinical and billing data.
- Limit use and disclosure of patient-identifiable data to the minimum necessary for the specific care, payment, or operations purpose.
- Do not use patient data from this environment for model training or analytics without explicit consent and governance approval.
- For Patient Discharge agents: confirm that any suicidal ideation or high-risk flags are acknowledged and escalated before discharge is considered complete.
- For Patient Discharge agents: ensure that a follow-up plan (appointments, community referrals, safety planning) is scheduled where clinically indicated.
- For Patient Discharge agents: never auto-complete discharge workflows when suicide risk is present and no safety plan is documented.
                </textarea>
                <div class="footer-actions">
                  <button class="btn" onclick="showToast('Policies edited (mock)')">Edit</button>
                  <button class="btn" onclick="showToast('Policy changes saved (mock)')">Save Draft</button>
                  <button class="btn primary" onclick="submitPoliciesForAgentic()">Submit to LLM for Agentic Referral</button>
                </div>
              </div>
              <div class="tabpane">
                <div class="split">
                  <div>
                    <div class="card">
                      <h4>Context Files</h4>
                      <div id="ctxList" style="max-height:40vh; overflow:auto; border:1px solid var(--border); border-radius:8px; padding:8px; background:#fff;"></div>
                    </div>
                  </div>
                  <div>
                    <div class="card">
                      <h4 id="ctxTitle">Preview</h4>
                      <p id="ctxPackHint" style="color:var(--muted); font-size:12px; margin-top:-4px; margin-bottom:4px;"></p>
                      <div id="ctxPreview" style="white-space:pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; background:#0b1020; color:#e2e8f0; padding:12px; border-radius:8px; max-height:40vh; overflow:auto;"></div>
                    </div>
                    <div class="card" style="margin-top:12px;">
                      <h4>Add Context File</h4>
                      <div class="row">
                        <select id="ctxDir" style="max-width:180px;">
                          <option value="specs">specs/</option>
                          <option value="architecture">architecture/</option>
                          <option value="integrations">integrations/</option>
                          <option value="constraints">constraints/</option>
                        </select>
                        <input id="ctxUpload" type="file" multiple style="max-width:260px;" />
                        <button class="btn" onclick="uploadContextFiles()">Upload Selected</button>
                      </div>
                      <div style="margin-top:8px;">
                        <label for="ctxExistingFile" style="display:block; font-size:12px; color:var(--muted); margin-bottom:4px;">Existing files in folder</label>
                        <select id="ctxExistingFile" style="width:100%; max-width:360px;"></select>
                      </div>
                      <label style="margin-top:8px; display:block;">Or paste content to create a new file</label>
                      <textarea id="ctxContent" placeholder="Optional: paste text here and click Add to create a new file" style="height:160px;"></textarea>
                      <div class="row" style="margin-top:6px;">
                        <input id="ctxFile" placeholder="new_spec.md" style="max-width:260px;" />
                        <button class="btn" onclick="addContextFile()">Add</button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>
    </section>

    <!-- Screen 5: Eval & Rollout (Health Agents) -->
    <section id="eval" class="view">
      <h2 style="margin:8px 0;">Evaluation & Rollout</h2>
      <div class="row" style="justify-content: space-between; align-items: center;">
        <p id="evalSubtext" style="color:var(--muted); margin:0;">Health Agents  Patient Discharge  Proposed Prompt Version v1.0.0</p>
        <div class="row" style="gap:8px;">
          <label for="evalContext" style="font-size:12px; color:var(--muted);">Evaluation context</label>
          <select id="evalContext" style="max-width:260px;">
            <option value="discharge">Patient Discharge</option>
            <option value="agentic">Agentic Referral (LLM plan)</option>
            <option value="consent">Consent Check</option>
            <option value="travel">Travel (Uber Booking)</option>
          </select>
        </div>
      </div>

      <div id="evalMetrics" class="metrics">
        <div class="card">
          <strong>Before</strong><br />
          Baseline metrics will load here.
        </div>
        <div class="card">
          <strong>After (Test Run)</strong><br />
          Updated metrics will load here.
        </div>
        <div class="card">
          <strong>Confidence</strong><br />
          Eval coverage and policy breach summary will load here.
        </div>
        <div class="card">
          <strong>Notes</strong><br />
          Scenario-specific notes will load here.
        </div>
      </div>

      <div class="card">
        <h3>Test Suites</h3>
        <table>
          <thead>
            <tr><th>Suite</th><th>Status</th><th>Passed / Total</th><th>Notes</th></tr>
          </thead>
          <tbody id="evalSuitesBody">
            <tr><td>Loading…</td><td></td><td></td><td></td></tr>
          </tbody>
        </table>
      </div>

      <div class="card">
        <h3>Rollout</h3>
        <div class="row">
          <label style="min-width:140px;">Strategy</label>
          <select id="rolloutStrategy" style="max-width: 260px;">
            <option>Canary (5%)</option>
            <option>Gradual (5% → 25% → 100%)</option>
            <option>Full prod</option>
          </select>
          <label style="min-width:140px;">Region/Tenant</label>
          <select id="rolloutRegion" style="max-width: 260px;">
            <option>All</option>
            <option>SA Water</option>
            <option>GWW</option>
          </select>
        </div>
        <div class="row" style="justify-content:flex-end; margin-top:10px;">
          <button class="btn" onclick="goToView('agent')">Back to Agent</button>
          <button class="btn" onclick="goToView('studio')">Back to Prompt Studio</button>
          <button class="btn primary" onclick="deploy()">Deploy</button>
        </div>
      </div>
    </section>
  </main>

  

  <!-- Review Modal -->
  <div id="reviewModal" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <header class="row" style="justify-content: space-between;">
        <strong>Escalation Review</strong>
        <button class="btn" onclick="closeModal('reviewModal')">Close</button>
      </header>
      <div class="grid">
        <div class="card">
          <h4>Context Summary</h4>
          <p id="reviewContext">Change of Ownership request for account #134593. Payment plan active; customer marked as vulnerable.</p>
        </div>
        <div class="card">
          <h4>Agent’s Proposed Action</h4>
          <p>Disconnect service due to overdue balance.</p>
        </div>
      </div>
      <footer>
        <button class="btn" onclick="showToast('Edited (mock)')">Edit</button>
        <button class="btn" onclick="showToast('Rejected (mock)')">Reject</button>
        <button class="btn primary" onclick="showToast('Approved (mock)')">Approve</button>
      </footer>
    </div>
  </div>

  <!-- Generic Edit Modal -->
  <div id="editModal" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <header class="row" style="justify-content: space-between;">
        <strong id="editTitle">Edit</strong>
        <button class="btn" onclick="closeModal('editModal')">Close</button>
      </header>
      <label id="editLabel">Edit Text</label>
      <textarea id="editTextarea" style="height:220px;"></textarea>
      <footer>
        <button class="btn" onclick="discardEdit()">Discard</button>
        <button class="btn" onclick="saveDraft()">Save Draft</button>
      </footer>
    </div>
  </div>

  <!-- Add Example Modal -->
  <div id="addExampleModal" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <header class="row" style="justify-content: space-between;">
        <strong>Add Example from Escalation</strong>
        <button class="btn" onclick="closeModal('addExampleModal')">Close</button>
      </header>
      <div class="grid">
        <div>
          <label>Scenario Name</label>
          <input type="text" id="exName" placeholder="e.g., Payment plan active – do not disconnect" />
        </div>
        <div>
          <label>Expected Behaviour</label>
          <textarea id="exExpected" style="height:120px;">Keep connected; notify customer; schedule follow-up.</textarea>
        </div>
      </div>
      <footer>
        <button class="btn" onclick="showToast('Cancelled')">Cancel</button>
        <button class="btn primary" onclick="showToast('Example added (mock)'); closeModal('addExampleModal')">Add Example</button>
      </footer>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    // Agent execution config (update baseUrl/path to match your Health services)
    const AGENTS_EXEC = {
      baseUrl: 'http://localhost:8000',
      path: '/agents/run',
      perAgent: {
        'Balance Transfer Agent': '/agents/balance-transfer/run',
        'Ownership Trigger Agent': '/agents/ownership-trigger/run',
        'Special Read Scheduler Agent': '/agents/special-read-scheduler/run',
        'Patient Discharge Trigger': '/agents/patient-discharge-trigger/run',
        'Referral Agent': '/agents/referral/run'
      }
    };

    // Prompt Studio packs (Water + Health, including Hospital Discharge agents)
    const PROMPT_PACKS = {
      'SA Water – CoO Core v1.3': {
        domain: 'water',
        title: 'SA Water – CoO Core v1.3',
        desc: 'Core prompts for Change of Ownership billing flows.',
        affects: 'Balance Transfer Agent • Ownership Trigger Agent • Special Read Scheduler Agent',
        instructions: document.getElementById('packInstructions')?.value || ''
      },
      'SA Water – Vulnerable Customer Handling v1.1': {
        domain: 'water',
        title: 'SA Water – Vulnerable Customer Handling v1.1',
        desc: 'Guidance to protect vulnerable customers during billing and change-of-ownership flows.',
        affects: 'Balance Transfer Agent • Ownership Trigger Agent • Special Read Scheduler Agent',
        instructions: document.getElementById('packInstructions')?.value || ''
      },
      'GWW – Grange Billing Twin v0.9': {
        domain: 'water',
        title: 'GWW – Grange Billing Twin v0.9',
        desc: 'Billing twin prompts for GWW demo (CoO + meter reads).',
        affects: 'Balance Transfer Agent • Ownership Trigger Agent',
        instructions: 'Placeholder instructions for GWW – Grange Billing Twin v0.9.'
      },
      'Australian Health Privacy Regulations': {
        domain: 'health',
        title: 'Australian Health Privacy Regulations',
        desc: 'High-level prompts to apply Australian health privacy regulations across Health agents.',
        affects: 'All Health Agents',
        instructions: 'Placeholder summary of APP 6/11, state Health Records Acts, and data minimisation guardrails.',
        policies: `- Apply Australian health privacy regulations (APP 6/11, state Health Records Acts) to all clinical and billing data.\n- Limit use and disclosure of identifiable data to the minimum necessary for care, payment or operations.\n- Do not use this environment for model training or analytics without explicit consent and governance approval.`,
        examples: [
          { scenario:'Use discharge data for care coordination', status:'Passed', last_run:'Today' },
          { scenario:'Share data for model training without consent', status:'Blocked', last_run:'Today' }
        ],
        context_hint: 'Applies to all Health Agents as a cross-cutting privacy layer.',
        context_preview: 'Australian Health Privacy Regulations (APP 6/11, state Health Records Acts) enforce strict limits on secondary use and disclosure of health information...'
      },
      'Patient Discharge Process': {
        domain: 'health',
        title: 'Patient Discharge Process',
        desc: 'High-level prompts for patient discharge coordination across Health agents.',
        affects: 'Patient Discharge Trigger • Agentic Referral • Consent • Travel',
        instructions: 'Placeholder instructions for the overall Patient Discharge Process pack.'
      },
      'Hospital – Discharge Readiness & Risk Agent': {
        domain: 'health',
        title: 'Hospital – Discharge Readiness & Risk Agent',
        desc: 'LLM prompt for the Discharge Readiness & Risk Agent (LACE+ / HOSPITAL style factors).',
        affects: 'discharge_readiness_agent',
        instructions: `SYSTEM:
You are the Discharge Readiness & Risk Agent for a hospital.
Your goal is to:
1) Assess whether the patient is likely to be ready for discharge in the next 24–48 hours;
2) Estimate readmission risk using LACE+ and HOSPITAL-style factors;
3) Recommend which discharge pathway bundle the team should use (LOW / MODERATE / HIGH risk).

You must:
- Be conservative about safety.
- Flag high-risk medicines explicitly (e.g., anticoagulants, insulin, opioids).
- Avoid changing orders yourself – you only RECOMMEND and EXPLAIN.

CONTEXT:
- Current inpatient encounter:
{{encounter_context}}   # from PAS_ADMISSION_ENCOUNTER
- Patient demographics and social factors:
{{demographics_context}}   # from EMR_PATIENT_DEMOGRAPHICS, EMR_SOCIAL_HISTORY
- Diagnoses and procedures:
{{diagnosis_context}}      # from EMR_DIAGNOSIS, EMR_PROCEDURE
- Recent ED visits and admissions:
{{history_context}}        # from PAS_HISTORICAL_ENCOUNTERS
- Vitals and key labs:
{{vitals_labs_context}}    # from EMR_VITALS, EMR_LAB_RESULTS
- Pre-computed risk scores (if available):
{{risk_scores_context}}    # from RISK_SCORE_LACE_PLUS, RISK_SCORE_HOSPITAL

ASSISTANT:
1) Summarise in 2–3 bullet points:
   - Current clinical status relevant to discharge (stable/unstable, oxygen, mobility, cognition).
   - Key risk drivers (e.g., heart failure, COPD, polypharmacy, recent ED usage, lives alone, language barrier).

2) Assign:
   - discharge_readiness: one of ["NOT_READY", "POSSIBLY_READY_24H", "READY_24_48H", "READY_NOW"]
   - lace_plus_risk_level: ["LOW", "MODERATE", "HIGH"]
   - hospital_risk_level: ["LOW", "INTERMEDIATE", "HIGH"]
   - overall_risk_band: ["LOW", "MODERATE", "HIGH"]

3) Recommend a discharge pathway bundle:
   - For LOW risk: standard discharge bundle with basic education and 1 GP follow-up.
   - For MODERATE risk: enhanced bundle with detailed education, GP + specialist follow-up and early check-in.
   - For HIGH risk: intensive bundle including community services, frequent monitoring, rapid escalation criteria.

4) Output strict JSON only with this structure:

{
  "patient_id": "<PATIENT_ID>",
  "encounter_id": "<ENCOUNTER_ID>",
  "summary": [
    "<bullet 1>",
    "<bullet 2>",
    "<bullet 3>"
  ],
  "discharge_readiness": "<see above>",
  "lace_plus_risk_level": "<see above>",
  "hospital_risk_level": "<see above>",
  "overall_risk_band": "<see above>",
  "recommended_bundle": "<LOW|MODERATE|HIGH>",
  "key_risk_drivers": [
    "<short phrase>",
    "<short phrase>"
  ]
}`,
        policies: `- Be conservative and safety-first; if data is missing or ambiguous, treat risk as higher.\n- Never mark a patient READY_NOW when vital signs or labs are clearly unstable.\n- Respect privacy rules from the Australian Health Privacy Regulations pack when building context.`,
        examples: [
          { scenario:'High LACE+/HOSPITAL with unstable vitals', status:'Classified HIGH risk', last_run:'Today' },
          { scenario:'Short LOS, no comorbidities, good support', status:'Classified LOW risk', last_run:'Today' }
        ],
        context_hint: 'Uses EMR/PAS CSVs for encounters, diagnoses, vitals, labs and risk scores to classify discharge readiness.',
        context_preview: 'EMR_PATIENT_DEMOGRAPHICS.csv + PAS_ADMISSION_ENCOUNTER.csv + EMR_DIAGNOSIS.csv + PAS_HISTORICAL_ENCOUNTERS.csv + EMR_VITALS.csv + EMR_LAB_RESULTS.csv + optional RISK_SCORE_*.csv'
      },
      'Hospital – Medication Reconciliation Agent': {
        domain: 'health',
        title: 'Hospital – Medication Reconciliation & Education Agent',
        desc: 'LLM prompt for the Medication Reconciliation & Education Agent.',
        affects: 'medication_reconciliation_agent',
        instructions: `SYSTEM:
You are the Medication Reconciliation & Education Agent.
Your tasks are:
1) Compare home, in-hospital and proposed discharge medications.
2) Identify discrepancies, potential safety issues and polypharmacy concerns.
3) Generate clear patient-friendly education points for the final discharge medication list.

You must:
- Be conservative about safety.
- Flag high-risk medicines explicitly (e.g., anticoagulants, insulin, opioids).
- Avoid changing orders yourself – you only RECOMMEND and EXPLAIN.

CONTEXT:
- Home medications before admission:
{{home_meds_context}}       # from EMR_HOME_MEDICATIONS
- In-hospital active medications:
{{hospital_meds_context}}   # from EMR_MEDICATIONS
- Proposed discharge medications:
{{discharge_meds_context}}  # from EMR_DISCHARGE_MEDICATIONS
- Relevant diagnoses/conditions:
{{diagnosis_context}}       # from EMR_DIAGNOSIS
- Medication risk metadata:
{{medication_reference}}    # high-risk flags, class, etc.

ASSISTANT:
1) Produce a concise reconciliation summary:
   - medications_continued
   - medications_stopped
   - medications_started
   - medication_changes (dose/route/frequency changes)

2) Highlight safety issues (if any):
   - therapeutic duplication
   - high-risk meds needing explicit counselling
   - obvious contraindications based on diagnoses

3) Create patient-friendly education points (short, simple language):
   - 1–3 bullets per high-risk or clinically important medicine.

4) Output strict JSON only:

{
  "patient_id": "<PATIENT_ID>",
  "encounter_id": "<ENCOUNTER_ID>",
  "reconciliation": {
    "continued": ["<drug A>", "<drug B>"],
    "stopped": ["<drug C>"],
    "started": ["<drug D>"],
    "changed": [
      {
        "medication": "<name>",
        "change": "<brief description>"
      }
    ]
  },
  "safety_flags": [
    "<short safety issue, if any>"
  ],
  "education_points": [
    "<short, patient-friendly bullet point>",
    "<…>"
  ]
}`,
        policies: `- Do not modify medication orders directly; only recommend changes and explain the rationale.\n- Always flag high-risk medicines (anticoagulants, insulin, opioids) for explicit counselling.\n- Prefer simple, patient-friendly language in education points.`,
        examples: [
          { scenario:'HF patient with ACE inhibitor dose reduction', status:'Explains change and monitoring', last_run:'Today' },
          { scenario:'New opioid at discharge', status:'Flags as high-risk with counselling points', last_run:'Today' }
        ],
        context_hint: 'Compares EMR_HOME_MEDICATIONS, EMR_MEDICATIONS and EMR_DISCHARGE_MEDICATIONS plus diagnosis + medication reference.',
        context_preview: 'HOME vs in-hospital vs discharge medicines from CSVs, with a reference table for high-risk drugs and classes.'
      },
      'Hospital – Follow-Up Orchestration Agent': {
        domain: 'health',
        title: 'Hospital – Follow-Up Orchestration Agent',
        desc: 'LLM prompt for the Follow-Up Orchestration Agent.',
        affects: 'followup_orchestration_agent',
        instructions: `SYSTEM:
You are the Follow-Up Orchestration Agent.
Your job is to ensure each discharged patient has the right mix of follow-up appointments booked and clearly documented.

You DO NOT directly access booking systems; instead you:
- Decide what appointments are clinically required.
- Check what is already booked.
- Recommend what still needs to be booked, when, and with whom.

CONTEXT:
- Discharge diagnoses, procedures and risk band:
{{discharge_context}}            # from EMR_DIAGNOSIS, EMR_PROCEDURE, risk agent output
- Required follow-up rules:
{{required_followup_rules}}      # from REQUIRED_FOLLOW_UP_APPOINTMENTS
- Existing scheduled appointments:
{{scheduled_appointments}}       # from APPOINTMENT_SCHEDULE
- GP and specialist directory (if relevant):
{{provider_directory}}           # from EHR_GP_INFORMATION, SPECIALIST_DIRECTORY

ASSISTANT:
1) Determine required follow-ups (e.g. GP in 3–5 days, cardiology in 2–4 weeks, pathology in 1 week), based on the specific patient’s diagnoses, risk band and rules.
2) Ensure that every discharged patient has a GP follow-up with their relevant GP unless the context clearly indicates this is not appropriate (e.g. GP does not exist or another service is explicitly responsible).
3) For mental-health or suicide-risk patients, ensure that an appropriate mental-health/community follow-up is present, or explicitly explain in the reasoning why no such follow-up is required.
4) Compare required follow-ups with already scheduled appointments and mark:
   - "ALREADY_SCHEDULED" when a matching appointment exists.
   - "MISSING" when an appointment is clinically required but not yet booked.

5) For each follow-up, propose:
   - type (GP, cardiology, respiratory, pathology, allied health, mental health, etc.)
   - recommended_timeframe (e.g. "within 7 days")
   - channel (in-person, telehealth, phone, etc.)
   - priority / urgency band (LOW/MODERATE/HIGH)
   - clear clinical reason.

6) Output strict JSON only:

{
  "patient_id": "<PATIENT_ID>",
  "encounter_id": "<ENCOUNTER_ID>",
  "required_followups": [
    {
      "type": "<GP|Specialist|Pathology|AlliedHealth>",
      "reason": "<clinical reason>",
      "recommended_timeframe": "<e.g. within 7 days>",
      "status": "<ALREADY_SCHEDULED|MISSING>",
      "scheduled_details": {
        "appointment_id": "<if exists>",
        "date_time": "<ISO8601>",
        "provider_name": "<if known>"
      }
    }
  ]
}`,
            policies: `- Do not modify booking systems directly; only recommend changes and explain the rationale.\n- Always flag high-risk patients (e.g., suicide risk, complex comorbidities) for explicit follow-up, and ensure an appropriate mental-health/community follow-up exists when indicated.\n- Ensure every discharged patient has a GP follow-up with their own GP (from EMR GP information) unless the context clearly shows this is not required or appropriate, and document that reasoning.\n- Respect genuinely low-risk cases where no specialist follow-up beyond routine GP review is needed.\n- Prefer simple, patient-friendly language when describing follow-up plans.`,
            examples: [
              { scenario:'Suicide risk patient with no safety plan', status:'Flags high-risk and recommends urgent GP follow-up', last_run:'Today' },
              { scenario:'Routine post-discharge GP follow-up', status:'Scheduled for 3–5 days post-discharge', last_run:'Today' }
            ],
            context_hint: 'Uses EMR/PAS CSVs for discharge diagnoses, procedures, risk band, follow-up rules, scheduled appointments and GP/specialist directory.',
            context_preview: 'Discharge diagnoses, procedures, risk band, follow-up rules, scheduled appointments and GP/specialist directory from CSVs.'
          },
          'Hospital – GP & Community Handoff Agent': {
            domain: 'health',
            title: 'Hospital – GP & Community Handoff Agent',
            desc: 'LLM prompt for the GP & Community Handoff Agent.',
            affects: 'gp_community_handoff_agent',
            instructions: `SYSTEM:
You are the GP & Community Handoff Agent.
Your tasks:
1) Summarise the hospital stay in a GP-friendly way.
2) Highlight what the GP and community services need to do.

CONTEXT:
- Core clinical summary (diagnoses, procedures, hospital course):
{{clinical_summary_context}}     # from EMR_DIAGNOSIS, EMR_PROCEDURE, EMR_CLINICAL_NOTES
- Discharge medication summary:
{{medication_summary}}           # from medication agent output
- Follow-up plan and risk band:
{{followup_plan}}                # from followup agent output and risk agent output
- GP and community services data:
{{gp_info}}                      # from EHR_GP_INFORMATION
{{community_services}}           # from COMMUNITY_SERVICES_DIRECTORY

ASSISTANT:
1) Produce a succinct GP summary (max ~10 bullet points), covering:
   - reason for admission and key diagnoses
   - key in-hospital events/procedures
   - current problems and risks (including mental-health or suicide risk where present)
   - discharge medications (high level)
   - follow-up and monitoring plan, including which follow-ups the GP is responsible for.

2) Populate gp_handoff.summary_bullets with these key points so the GP can quickly understand the admission and discharge story.

3) Populate gp_handoff.gp_action_items with concrete actions the GP should take (e.g. review medications, check wounds, follow up on tests, confirm community supports). Include provider information or identifiers where available from gp_info.

4) Populate gp_handoff.community_referrals (or community_handoff) with any required community service actions, including service name, reason_for_referral, priority and requested_followup timing.

5) Output strict JSON only:

{
  "patient_id": "<PATIENT_ID>",
  "encounter_id": "<ENCOUNTER_ID>",
  "gp_handoff": {
    "gp_id": "<GP_IDENTIFIER>",
    "summary_bullets": [
      "<bullet>",
      "<bullet>"
    ],
    "gp_action_items": [
      "<action item>"
    ]
  },
  "community_handoff": [
    {
      "service_id": "<COMMUNITY_SERVICE_ID>",
      "service_name": "<name>",
      "reason_for_referral": "<short text>",
      "priority": "<LOW|MEDIUM|HIGH>",
      "requested_followup": "<e.g. home visit within 48h>"
    }
  ]
}`,
            policies: `- Do not modify GP/community services directly; only recommend changes and explain the rationale.\n- Always flag high-risk patients (e.g., suicide risk, complex comorbidities) so that GP and community action items explicitly address those risks.\n- Ensure gp_handoff.summary_bullets and gp_action_items are populated for every discharge handover, not left empty.\n- Prefer simple, GP-friendly and patient-friendly language in summaries and recommendations.`,
            examples: [
              { scenario:'Suicide risk patient with no safety plan', status:'Flags high-risk and recommends urgent GP follow-up', last_run:'Today' },
              { scenario:'Routine post-discharge GP follow-up', status:'Scheduled for 3–5 days post-discharge', last_run:'Today' }
            ],
            context_hint: 'Uses EMR/PAS CSVs for core clinical summary, discharge medication summary, follow-up plan, risk band, GP and community services data.',
            context_preview: 'Core clinical summary, discharge medication summary, follow-up plan, risk band, GP and community services data from CSVs.'
          },
      'Hospital – Post-Discharge Monitoring Agent': {
        domain: 'health',
        title: 'Hospital – Post-Discharge Monitoring Agent',
        desc: 'LLM prompt for the Post-Discharge Monitoring Agent.',
        affects: 'post_discharge_monitoring_agent',
        instructions: `SYSTEM:
You are the Post-Discharge Monitoring Agent.
You work with a digital avatar channel to:
1) Run scheduled check-ins with patients.
2) Interpret their responses for early signs of deterioration.
3) Recommend early intervention actions.

You do not override clinicians. You propose alerts and suggested actions.

CONTEXT:
- Monitoring plan and thresholds:
{{monitoring_plan}}           # from POST_DISCHARGE_MONITORING_PLAN
- Recent avatar interactions:
{{avatar_check_ins}}          # from AVATAR_CHECK_IN_SCHEDULE, PATIENT_REPORTED_DATA
- Clinical risk band:
{{risk_band}}                 # from risk agent

ASSISTANT:
1) For the next scheduled check-in window, propose:
   - check-in type (SMS, app, phone)
   - 3–5 short questions tailored to the condition and risk band.

2) Review recent patient responses and decide if any alert should be raised:
   - symptom worsening
   - medication non-adherence
   - social or practical red flags (can’t get to GP, no transport, etc.)

3) If alert is needed, suggest:
   - alert_priority: ["INFO", "WATCH", "ESCALATE"]
   - recommended_action: e.g. "nurse calls patient within 2 hours", "flag for GP review", etc.

4) Output strict JSON only:

{
  "patient_id": "<PATIENT_ID>",
  "encounter_id": "<ENCOUNTER_ID>",
  "next_check_in": {
    "scheduled_time": "<ISO8601>",
    "channel": "<SMS|APP|PHONE>",
    "questions": [
      "<short question>",
      "<short question>"
    ]
  },
  "alerts": [
    {
      "alert_id": "<generated>",
      "priority": "<INFO|WATCH|ESCALATE>",
      "reason": "<short text>",
      "recommended_action": "<short text>"
    }
  ]
}`,
        policies: `- Do not override clinicians; only propose alerts and suggested actions.\n- Always flag high-risk patients (e.g., suicide risk, complex comorbidities) for explicit follow-up.\n- Prefer simple, patient-friendly language in recommendations.`,
        examples: [
          { scenario:'Suicide risk patient with no safety plan', status:'Flags high-risk and recommends urgent GP follow-up', last_run:'Today' },
          { scenario:'Routine post-discharge GP follow-up', status:'Scheduled for 3–5 days post-discharge', last_run:'Today' }
        ],
        context_hint: 'Uses POST_DISCHARGE_MONITORING_PLAN, AVATAR_CHECK_IN_SCHEDULE, PATIENT_REPORTED_DATA and risk agent output.',
        context_preview: 'Monitoring plan, recent avatar interactions, clinical risk band from CSVs.'
      },
      'Hospital – Outcomes & Governance Analytics Agent': {
        domain: 'health',
        title: 'Hospital – Outcomes & Governance Analytics Agent',
        desc: 'LLM prompt for the Outcomes & Governance Analytics Agent.',
        affects: 'discharge_outcomes_analytics_agent',
        instructions: `SYSTEM:
You are the Outcomes & Governance Analytics Agent.
You aggregate discharge pathway performance for clinical governance and business value tracking.

Your goals:
- Track readmissions, ED returns, follow-up completion, and adherence to recommended bundles.
- Surface insights the Discharge Coordination steering group can act on.

CONTEXT:
- Outcome tracking data (per patient):
{{outcome_tracking}}        # from OUTCOME_TRACKING
- Aggregated KPIs:
{{performance_metrics}}     # from PERFORMANCE_METRICS
- Notes and improvement ideas:
{{improvement_log}}         # from CONTINUOUS_IMPROVEMENT_LOG

ASSISTANT:
1) Compute (or summarise if pre-computed) the following for the dashboard:
   - 30-day readmission rate (overall and by risk band).
   - % of patients with GP follow-up ≤7 days.
   - % with completed medication reconciliation.
   - Average LOS vs baseline.
   - Any financial impact metrics provided.

2) Identify 3–5 key insights or trends that leadership should see, e.g.:
   - "High-risk HF patients with no GP follow-up ≤7 days have much higher readmission."
   - "Ward X consistently delays discharge summaries."

3) Output strict JSON only:

{
  "dashboard_period": {
    "start_date": "<YYYY-MM-DD>",
    "end_date": "<YYYY-MM-DD>"
  },
  "kpis": {
    "readmission_30d_rate": 0.18,
    "gp_followup_7d_completion": 0.72,
    "med_reconciliation_completion": 0.88,
    "avg_los_days": 5.4,
    "baseline_avg_los_days": 6.2
  },
  "insights": [
    "<insight 1>",
    "<insight 2>",
    "<insight 3>"
  ]
}`,
        policies: `- Report KPIs honestly, without hiding poor performance.\n- Break down outcomes by risk band and bundle adherence.\n- Highlight actionable trends rather than trivial correlations.`,
        examples: [
          { scenario:'HIGH risk patients without GP ≤7 days', status:'Flags higher readmission rate', last_run:'Today' }
        ],
        context_hint: 'Aggregates OUTCOME_TRACKING, PERFORMANCE_METRICS and improvement logs.',
        context_preview: '30-day readmissions, GP follow-up, med recon completion and LOS vs baseline, sliced by risk band.'
      }
    };

    function initPromptStudio() {
      const domainSel = document.getElementById('studioDomain');
      const packButtons = Array.from(document.querySelectorAll('#packList button'));
      const titleEl = document.getElementById('packTitle');
      const descEl = document.getElementById('packDesc');
      const affectsEl = document.getElementById('packAffects');
      const instrEl = document.getElementById('packInstructions');
      const exBody = document.getElementById('packExamplesBody');
      const polEl = document.getElementById('policyText');
      const ctxHint = document.getElementById('ctxPackHint');
      const ctxPrev = document.getElementById('ctxPreview');
      if (!domainSel || !packButtons.length || !titleEl || !descEl || !affectsEl || !instrEl) return;

      function applyDomainFilter() {
        const dom = domainSel.value || 'water';
        packButtons.forEach(btn => {
          const bDom = btn.dataset.domain || 'water';
          btn.style.display = (bDom === dom) ? '' : 'none';
        });
      }

      function applyPack(name) {
        const cfg = PROMPT_PACKS[name];
        if (!cfg) return;
        titleEl.textContent = cfg.title || name;
        descEl.textContent = cfg.desc || descEl.textContent;
        affectsEl.textContent = cfg.affects || affectsEl.textContent;
        instrEl.value = cfg.instructions || instrEl.value;
        if (polEl && cfg.policies) polEl.value = cfg.policies;
        if (exBody && Array.isArray(cfg.examples)) {
          exBody.innerHTML = '';
          cfg.examples.forEach(ex => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${ex.scenario}</td><td><span class="pill ok">${ex.status}</span></td><td>${ex.last_run}</td>`;
            exBody.appendChild(tr);
          });
        }
        if (ctxHint && cfg.context_hint) ctxHint.textContent = cfg.context_hint;
        if (ctxPrev && cfg.context_preview) ctxPrev.textContent = cfg.context_preview;
        packButtons.forEach(btn => {
          btn.classList.toggle('active', btn.dataset.pack === name);
        });
      }

      packButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          const name = btn.dataset.pack;
          if (name) applyPack(name);
        });
      });

      domainSel.addEventListener('change', () => {
        applyDomainFilter();
      });

      // Initial state: respect current domain and default to existing water pack
      applyDomainFilter();
      applyPack('SA Water – Vulnerable Customer Handling v1.1');
    }

    // Navigation
    const buttons = document.querySelectorAll('#nav button');
    const views = document.querySelectorAll('.view');

    async function pushAllPromptPacks() {
      try {
        const packs = Object.entries(PROMPT_PACKS || {}).map(([name, cfg]) => ({
          name,
          domain: cfg.domain || '',
          instructions: cfg.instructions || '',
          policies_markdown: cfg.policies || ''
        }));
        if (!packs.length) return;
        await fetch('http://localhost:8000/prompt-packs/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ packs })
        });
      } catch (e) {
        // Best-effort only; failures should not break the demo UI.
        console.warn('Failed to push prompt packs', e);
      }
    }

    function goToView(id) {
      views.forEach(v => v.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      buttons.forEach(b => b.classList.toggle('active', b.dataset.view === id));
      window.scrollTo({ top: 0, behavior: 'instant' });
      // When opening the Health Agents view, push all configured prompt packs
      // to the backend so the live LLM sees the latest instructions/policies.
      if (id === 'agent') {
        pushAllPromptPacks();
      }
    }

    buttons.forEach(b => b.addEventListener('click', () => goToView(b.dataset.view)));

    // Agent execution helpers
    function val(id){ const el=document.getElementById(id); return el? (el.value||'').trim() : ''; }
    function sel(id){ const el=document.getElementById(id); return el? (el.value||'').trim() : ''; }
    function agentExecUrl(name) {
      const cfg = AGENTS_EXEC || {};
      if (!cfg.baseUrl) return '#';
      if (cfg.perAgent && cfg.perAgent[name]) return cfg.baseUrl + cfg.perAgent[name];
      const q = encodeURIComponent(name);
      const path = cfg.path || '/agents/run';
      return cfg.baseUrl + path + '?name=' + q;
    }
    async function executeAgent(name) {
      const url = agentExecUrl(name);
      showToast('Executing ' + name + '…');
      try {
        const res = await fetch(url, { method: 'POST' });
        if (res.ok) {
          showToast('Started: ' + name);
        } else {
          showToast('Failed to start ' + name + ' (HTTP ' + res.status + ')');
        }
      } catch (e) {
        // Fallback: open the execution URL
        window.open(url, '_blank');
        showToast('Could not reach service; opened link.');
      }
    }

    const EXEC_GRAPH_TEMPLATES = {
      discharge: [
        'Health UI',
        'Ownership Trigger API (/demo/discharge)',
        'MCP: Epic (discharge_event, patient_bundle)',
        'MCP: HCA (directory search)',
        'LLM Planner / Risk Scoring',
        'Tasks & Notifications'
      ],
      agenticReferral: [
        'Health UI',
        'Ownership Trigger API (/demo/agentis-referral)',
        'MCP: Epic (clinical data)',
        'MCP: HCA (providers & consent)',
        'LLM Agentic Planner',
        'Tasks • Messages • Sharing Decisions'
      ],
      consent: [
        'Health UI',
        'Ownership Trigger API (/demo/consent-check)',
        'MCP: Policy Engine',
        'LLM/Rules Evaluation',
        'Allow / Deny Decision'
      ],
      uber: [
        'Health UI',
        'Ownership Trigger API (/demo/uber)',
        'LLM / Rules (purpose selection)',
        'Transport Booking Service'
      ]
    };

    function appendExecutionGraph(kind, payload, data) {
      const panel = document.getElementById('ha_graph');
      if (!panel) return;
      const nodes = EXEC_GRAPH_TEMPLATES[kind] || ['Health UI', 'Ownership Trigger API', 'Backend Logic'];
      const ts = new Date();
      const label = {
        discharge: 'Discharge',
        agenticReferral: 'Agentic Referral',
        consent: 'Consent Check',
        uber: 'Travel (Uber)'
      }[kind] || kind;
      const runId = ts.toLocaleTimeString();

      const row = document.createElement('div');
      row.style.display = 'flex';
      row.style.flexDirection = 'column';
      row.style.gap = '4px';
      row.style.padding = '6px 4px';
      row.style.borderTop = '1px solid var(--border)';

      const header = document.createElement('div');
      header.style.display = 'flex';
      header.style.justifyContent = 'space-between';
      header.innerHTML = `<span style="font-weight:600;">${label}</span><span style="color:var(--muted);">${runId}</span>`;
      row.appendChild(header);

      const flow = document.createElement('div');
      flow.style.display = 'flex';
      flow.style.flexWrap = 'wrap';
      flow.style.alignItems = 'center';
      flow.style.gap = '4px';
      nodes.forEach((n, idx) => {
        const node = document.createElement('span');
        node.textContent = n;
        node.style.padding = '2px 8px';
        node.style.borderRadius = '999px';
        node.style.background = idx === 0 ? '#e0f2fe' : (idx === nodes.length - 1 ? '#ecfdf5' : '#eef2ff');
        node.style.border = '1px solid #d4d4d8';
        flow.appendChild(node);
        if (idx < nodes.length - 1) {
          const arrow = document.createElement('span');
          arrow.textContent = '➜';
          arrow.style.color = '#6b7280';
          flow.appendChild(arrow);
        }
      });
      row.appendChild(flow);

      // Append without clearing previous runs
      panel.appendChild(row);
    }

    // CoO / Billing flows wired to embedded coo-demo service
    async function runCooFlow(kind) {
      const ep = (COO_API.endpoints || {})[kind];
      if (!ep) { showToast('Unknown CoO flow: ' + kind); return; }
      const url = (COO_API.baseUrl || '') + ep;
      const label = {
        'address-standardize': 'Address Standardize',
        'ownership': 'Ownership (LLM Route)',
        'ownership-deterministic': 'Ownership (Deterministic)',
        'special-read': 'Special Read Scheduler',
        'bill-transfer': 'Bill Transfer',
        'reset': 'Reset CoO Demo'
      }[kind] || kind;
      showToast('Running CoO flow: ' + label + '…');
      try {
        const res = await fetch(url, { method: 'POST' });
        const data = await res.json().catch(() => ({}));
        const jsonEl = document.getElementById('coo_result_json');
        const textEl = document.getElementById('coo_result_text');
        if (jsonEl) jsonEl.textContent = JSON.stringify(data, null, 2);
        if (textEl) textEl.innerHTML = formatCooResult(kind, data);
        if (!res.ok) showToast(label + ' failed (HTTP ' + res.status + ')');
        else showToast(label + ' completed');
      } catch (e) {
        const jsonEl = document.getElementById('coo_result_json');
        const textEl = document.getElementById('coo_result_text');
        const errObj = { error: String(e) };
        if (jsonEl) jsonEl.textContent = JSON.stringify(errObj, null, 2);
        if (textEl) textEl.innerHTML = '<p>CoO flow failed.</p>';
        showToast('Request error for CoO flow: ' + label);
      }
    }

    // Health API config (Ownership Trigger backend)
    const HEALTH_API = {
      baseUrl: 'http://127.0.0.1:8001',
      endpoints: {
        discharge: '/demo/discharge',
        agenticReferral: '/demo/agentis-referral',
        consent: '/demo/consent-check',
        uber: '/demo/uber',
        hd_step1: '/demo/hd-step1',
        hd_step2: '/demo/hd-step2',
        hd_step3: '/demo/hd-step3',
        hd_step4: '/demo/hd-step4',
        hd_step5: '/demo/hd-step5',
        hd_step6: '/demo/hd-step6'
      }
    };

    async function runHealthAgent(kind, payload, options) {
      const opts = options || {};
      const ep = (HEALTH_API.endpoints || {})[kind];
      if (!ep) {
        showToast('Unknown Health flow: ' + kind);
        return null;
      }
      const url = (HEALTH_API.baseUrl || '') + ep;
      const body = payload || {};
      showToast('Running Health flow: ' + kind + '…');
      let data = null;
      try {
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        data = await res.json().catch(() => ({}));
        if (!res.ok) {
          showToast('Health flow ' + kind + ' failed (HTTP ' + res.status + ')');
        } else {
          showToast('Health flow ' + kind + ' completed');
        }
      } catch (e) {
        data = { error: String(e) };
        showToast('Request error for Health flow: ' + kind);
      }
      try {
        writeResults(kind, data, !!opts.append);
        appendExecutionGraph(kind, body, data);
      } catch (e) {}
      return data;
    }

    function writeResults(kind, data, append) {
      const jsonEl = document.getElementById('ha_result_json');
      const textEl = document.getElementById('ha_result_text');
      if (!jsonEl && !textEl) return;
      if (!append) {
        if (jsonEl) jsonEl.textContent = '';
        if (textEl) textEl.innerHTML = '';
      }
      if (jsonEl) {
        const pretty = JSON.stringify(data, null, 2);
        if (append && jsonEl.textContent) {
          jsonEl.textContent = jsonEl.textContent + '\n\n' + pretty;
        } else {
          jsonEl.textContent = pretty;
        }
      }
      if (textEl) {
        const html = formatResult(kind, data);
        if (append && textEl.innerHTML) {
          textEl.innerHTML = textEl.innerHTML + html;
        } else {
          textEl.innerHTML = html;
        }
      }
    }

    // CoO / Billing via MCP-backed backend (Ownership Trigger service wraps CoO MCP tools)
    const COO_API = {
      // Reuse HEALTH_API.baseUrl so the app only talks to a single backend; that backend
      // uses a mock MCP server (mcp-coo-mock) to execute the actual CoO tools.
      get baseUrl() { return HEALTH_API.baseUrl || ''; },
      endpoints: {
        'address-standardize': '/coo/address-standardize',
        'ownership': '/coo/ownership',
        'ownership-deterministic': '/coo/ownership-deterministic',
        'special-read': '/coo/special-read',
        'bill-transfer': '/coo/bill-transfer',
        'reset': '/coo/reset'
      }
    };

    // --- Hospital Discharge mock dataset (20 inpatients + risk scores) ---
    const HD_PATIENTS = [
      { patientId:'P0001', name:'John Smith', ward:'Cardiology', lace:13, laceRisk:'HIGH', hosp:5, hospRisk:'INTERMEDIATE', status:'Ready 24–48h', atsi:false, ndis:true },
      { patientId:'P0002', name:'Mary Johnson', ward:'General Medicine', lace:10, laceRisk:'HIGH', hosp:3, hospRisk:'LOW', status:'Planning', atsi:false, ndis:false },
      { patientId:'P0003', name:'David Lee', ward:'Surgical', lace:1, laceRisk:'LOW', hosp:1, hospRisk:'LOW', status:'Planning', atsi:false, ndis:false },
      { patientId:'P0004', name:"Patricia O'Connor", ward:'Geriatric Medicine', lace:15, laceRisk:'HIGH', hosp:7, hospRisk:'HIGH', status:'Ready 24–48h', atsi:true, ndis:true },
      { patientId:'P0005', name:'Ahmed Hassan', ward:'Respiratory', lace:12, laceRisk:'HIGH', hosp:5, hospRisk:'INTERMEDIATE', status:'Planning', atsi:false, ndis:true },
      { patientId:'P0006', name:'Linda Nguyen', ward:'General Medicine', lace:9, laceRisk:'MODERATE', hosp:3, hospRisk:'LOW', status:'Planning', atsi:false, ndis:false },
      { patientId:'P0007', name:'Robert Brown', ward:'Cardiology', lace:13, laceRisk:'HIGH', hosp:5, hospRisk:'INTERMEDIATE', status:'Ready 24–48h', atsi:false, ndis:true },
      { patientId:'P0008', name:'Susan Wilson', ward:'General Medicine', lace:7, laceRisk:'MODERATE', hosp:2, hospRisk:'LOW', status:'Planning', atsi:false, ndis:false },
      { patientId:'P0009', name:'Peter Garcia', ward:'Respiratory', lace:11, laceRisk:'HIGH', hosp:5, hospRisk:'INTERMEDIATE', status:'Planning', atsi:false, ndis:true },
      { patientId:'P0010', name:'Angela Martin', ward:'Surgical', lace:6, laceRisk:'MODERATE', hosp:2, hospRisk:'LOW', status:'Planning', atsi:false, ndis:false },
      { patientId:'P0011', name:'Bruce Tan', ward:'Oncology', lace:15, laceRisk:'HIGH', hosp:7, hospRisk:'HIGH', status:'Ready 24–48h', atsi:false, ndis:true },
      { patientId:'P0012', name:'Chloe White', ward:'General Medicine', lace:5, laceRisk:'MODERATE', hosp:2, hospRisk:'LOW', status:'Planning', atsi:false, ndis:false },
      { patientId:'P0013', name:'Jason Kaur', ward:'Cardiology', lace:10, laceRisk:'HIGH', hosp:3, hospRisk:'LOW', status:'Planning', atsi:false, ndis:false },
      { patientId:'P0014', name:'Elena Petrov', ward:'Respiratory', lace:12, laceRisk:'HIGH', hosp:5, hospRisk:'INTERMEDIATE', status:'Ready 24–48h', atsi:false, ndis:false },
      { patientId:'P0015', name:'George Miller', ward:'Geriatric Medicine', lace:14, laceRisk:'HIGH', hosp:6, hospRisk:'INTERMEDIATE', status:'Ready 24–48h', atsi:false, ndis:true },
      { patientId:'P0016', name:'Isabel Lopez', ward:'Surgical', lace:7, laceRisk:'MODERATE', hosp:2, hospRisk:'LOW', status:'Planning', atsi:false, ndis:false },
      { patientId:'P0017', name:'Kevin Adams', ward:'General Medicine', lace:7, laceRisk:'MODERATE', hosp:2, hospRisk:'LOW', status:'Planning', atsi:false, ndis:false },
      { patientId:'P0018', name:'Nora Ali', ward:'General Medicine', lace:4, laceRisk:'LOW', hosp:2, hospRisk:'LOW', status:'Planning', atsi:false, ndis:false },
      { patientId:'P0019', name:'Leon Chan', ward:'Cardiology', lace:12, laceRisk:'HIGH', hosp:5, hospRisk:'INTERMEDIATE', status:'Ready 24–48h', atsi:false, ndis:true },
      { patientId:'P0020', name:'Grace Thompson', ward:'General Medicine', lace:8, laceRisk:'MODERATE', hosp:3, hospRisk:'LOW', status:'Planning', atsi:false, ndis:false }
    ];

    function renderHdPanel() {
      const kpiEl = document.getElementById('hd_kpi_strip');
      const tbody = document.getElementById('hd_inpatient_tbody');
      const stepsEl = document.getElementById('hd_step_cards');
      if (!kpiEl || !tbody || !stepsEl) return;

      const total = HD_PATIENTS.length;
      const high = HD_PATIENTS.filter(p => p.laceRisk === 'HIGH' || p.hospRisk === 'HIGH').length;
      const monitored = HD_PATIENTS.filter(p => p.status.indexOf('Ready') >= 0).length;
      const gp7d = Math.round((total - 3) / total * 100);
      const medRecon = 92;
      const readmit30 = 14;

      kpiEl.innerHTML = '';
      const tiles = [
        { label:'30-day readmission rate', value: readmit30 + '%'},
        { label:'% with GP follow-up ≤7 days', value: gp7d + '%'},
        { label:'Medication reconciliation completion %', value: medRecon + '%'},
        { label:'High-risk discharges under active monitoring', value: monitored + ' / ' + high }
      ];
      tiles.forEach(t => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `<div style="color:var(--muted); font-weight:600;">${t.label}</div><div style="font-size:22px; font-weight:800;">${t.value}</div>`;
        kpiEl.appendChild(card);
      });

      tbody.innerHTML = '';
      HD_PATIENTS.forEach(p => {
        const tr = document.createElement('tr');
        tr.style.cursor = 'pointer';
        tr.dataset.patientId = p.patientId;
        const riskLabel = (p.laceRisk === 'HIGH' || p.hospRisk === 'HIGH') ? 'HIGH' : (p.laceRisk === 'LOW' && p.hospRisk === 'LOW' ? 'LOW' : 'MOD');
        const pillCls = riskLabel === 'HIGH' ? 'pill err' : (riskLabel === 'MOD' ? 'pill warn' : 'pill ok');
        tr.innerHTML = `
          <td>${p.name} <span style="display:block; font-size:11px; color:var(--muted);">${p.patientId}</span></td>
          <td>${p.ward}</td>
          <td>${p.lace} <span style="display:block; font-size:11px; color:var(--muted);">${p.laceRisk}</span></td>
          <td>${p.hosp} <span style="display:block; font-size:11px; color:var(--muted);">${p.hospRisk}</span></td>
          <td><span class="${pillCls}">${riskLabel}</span></td>
          <td class="hd-status-cell">${getHdStatusLabel(p)}</td>
        `;
        tr.addEventListener('click', () => selectHdPatient(p.patientId));
        tbody.appendChild(tr);
      });

      if (HD_PATIENTS[0]) selectHdPatient(HD_PATIENTS[0].patientId);
    }

    function getHdStatusLabel(p) {
      const progressMap = window.__hdProgress || {};
      const n = progressMap[p.patientId] || 0;
      if (!n) return p.status;
      const titles = {
        1: 'Discharge Readiness & Risk',
        2: 'Medication Reconciliation',
        3: 'Follow-Up Orchestration',
        4: 'GP & Community Handoff',
        5: 'Post-Discharge Monitoring',
        6: 'Outcomes & Governance Analytics'
      };
      const title = titles[n] || '';
      return `${p.status} • Step ${n}/6${title ? ' – ' + title : ''}`;
    }

    function updateHdStatusForPatient(patientId) {
      const tbody = document.getElementById('hd_inpatient_tbody');
      if (!tbody) return;
      const tr = tbody.querySelector(`tr[data-patient-id="${patientId}"]`);
      if (!tr) return;
      const p = HD_PATIENTS.find(x => x.patientId === patientId);
      if (!p) return;
      const cell = tr.querySelector('.hd-status-cell');
      if (!cell) return;
      cell.textContent = getHdStatusLabel(p);
    }

    function selectHdPatient(patientId) {
      const p = HD_PATIENTS.find(x => x.patientId === patientId);
      window.__hdSelectedPatientId = p ? p.patientId : null;
      const selEl = document.getElementById('hd_selected_patient');
      const stepsEl = document.getElementById('hd_step_cards');
      const llmEl = document.getElementById('hd_llm_logic');
      const resJsonEl = document.getElementById('ha_result_json');
      const resTextEl = document.getElementById('ha_result_text');
      if (!selEl || !stepsEl) return;
      // When a new patient is selected, clear any previous agent results and
      // decision logic so the panels reflect only runs for the current patient.
      if (llmEl) llmEl.textContent = '';
      if (resJsonEl) resJsonEl.textContent = '';
      if (resTextEl) resTextEl.innerHTML = '';
      if (!p) {
        selEl.textContent = 'Select a patient to view their 6-step discharge bundle.';
        stepsEl.innerHTML = '';
        return;
      }
      selEl.innerHTML = `<strong>${p.name}</strong> • ${p.patientId} • ${p.ward}`;

      const riskLabel = (p.laceRisk === 'HIGH' || p.hospRisk === 'HIGH') ? 'HIGH' : (p.laceRisk === 'LOW' && p.hospRisk === 'LOW' ? 'LOW' : 'MODERATE');
      const riskCls = riskLabel === 'HIGH' ? 'pill err' : (riskLabel === 'MODERATE' ? 'pill warn' : 'pill ok');

      const progMap = window.__hdProgress || {};
      const stepDone = progMap[p.patientId] || 0;
      const step2StatusLabel = stepDone >= 2 ? 'Completed' : 'Pending';
      const step2StatusClass = stepDone >= 2 ? 'pill ok' : 'pill warn';

      const steps = [
        {
          id:'step1',
          title:'Step 1 • Discharge Readiness & Risk',
          body:`<p><strong>LACE+:</strong> ${p.lace} (${p.laceRisk}) &nbsp; <strong>HOSPITAL:</strong> ${p.hosp} (${p.hospRisk})</p>
                <p><strong>Overall risk:</strong> <span class="${riskCls}">${riskLabel}</span></p>
                <p><strong>Flags:</strong> ${p.atsi ? 'ATSI; ' : ''}${p.ndis ? 'NDIS participant; ' : ''}${(!p.atsi && !p.ndis) ? 'None recorded.' : ''}</p>
                <div class="row" style="justify-content:flex-end; margin-top:6px;"><button class="btn" onclick="runHdStep('step1')">Run Step 1 Agent</button></div>`
        },
        {
          id:'step2',
          title:'Step 2 • Med Reconciliation',
          body:`<p>Status: <span class="${step2StatusClass}">${step2StatusLabel}</span></p><p>Discrepancies: 1–2 typical per patient. Open generated PDF pack from the Medication Reconciliation Agent in the real console.</p><div class="row" style="justify-content:flex-end; margin-top:6px;"><button class="btn" onclick="runHdStep('step2')">Run Step 2 Agent</button></div>`
        },
        {
          id:'step3',
          title:'Step 3 • Follow-Up',
          body:'<p>GP and specialist appointments scheduled.</p><p>Click-through in the real console would show booked dates, completion and no-show flags.</p><div class="row" style="justify-content:flex-end; margin-top:6px;"><button class="btn" onclick="runHdStep(\'step3\')">Run Step 3 Agent</button></div>'
        },
        {
          id:'step4',
          title:'Step 4 • GP & Community Handoff',
          body:'<p>GP summary sent. Community referrals depend on risk bundle (HIGH risk → full services; LOW risk → slimmed set).</p><div class="row" style="justify-content:flex-end; margin-top:6px;"><button class="btn" onclick="runHdStep(\'step4\')">Run Step 4 Agent</button></div>'
        },
        {
          id:'step5',
          title:'Step 5 • Monitoring',
          body:`<p>Day 1–30 avatar check-ins configured. High-risk patients like ${p.name} would receive tighter monitoring.</p><div class="row" style="justify-content:flex-end; margin-top:6px;"><button class="btn" onclick="runHdStep('step5')">Run Step 5 Agent</button></div>`
        },
        {
          id:'step6',
          title:'Step 6 • Outcomes',
          body:'<p>This admission will contribute to readmission, adherence and follow-up KPIs aggregated by the Outcomes Agent.</p><div class="row" style="justify-content:flex-end; margin-top:6px;"><button class="btn" onclick="runHdStep(\'step6\')">Run Step 6 Agent</button></div>'
        }
      ];

      stepsEl.innerHTML = '';
      steps.forEach(s => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `<h4 style="margin:4px 0 6px;">${s.title}</h4>${s.body}`;
        stepsEl.appendChild(card);
      }); 
    }

    function getPromptStudioContext() {
      const packName = window.__currentPackName || (document.querySelector('#packList button.active')?.dataset.pack) || '';
      const instrEl = document.getElementById('packInstructions');
      const polEl = document.getElementById('policyText');
      const domainSel = document.getElementById('studioDomain');
      return {
        pack: packName,
        domain: domainSel ? domainSel.value : '',
        instructions: instrEl ? instrEl.value : '',
        policies_markdown: polEl ? polEl.value : ''
      };
    }

    async function runHdStep(stepId) {
      const pid = window.__hdSelectedPatientId;
      if (!pid) { showToast('Select a patient in Hospital Discharge panel first.'); return; }
      const p = HD_PATIENTS.find(x => x.patientId === pid);
      if (!p) { showToast('Patient not found in Hospital Discharge dataset.'); return; }
      const kind = 'hd_' + stepId;

      // Automatically choose the relevant Prompt Studio pack for this step,
      // so the correct instructions/policies are always submitted to the LLM
      // without requiring the user to manually select/submit packs.
      const baseCtx = getPromptStudioContext();
      const packPerStep = {
        step1: 'Hospital – Discharge Readiness & Risk Agent',
        step2: 'Hospital – Medication Reconciliation Agent',
        step3: 'Hospital – Follow-Up Orchestration Agent',
        step4: 'Hospital – GP & Community Handoff Agent',
        step5: 'Hospital – Post-Discharge Monitoring Agent',
        step6: 'Hospital – Outcomes & Governance Analytics Agent'
      };
      const autoPackName = packPerStep[stepId] || baseCtx.pack || '';
      const packCfg = autoPackName && PROMPT_PACKS[autoPackName] ? PROMPT_PACKS[autoPackName] : null;
      const promptCtx = {
        pack: autoPackName,
        domain: (packCfg && packCfg.domain) || baseCtx.domain || 'health',
        // Prefer live Prompt Studio edits only when they correspond to the
        // same pack; otherwise use the default instructions/policies for the
        // auto-selected health pack so each step runs correctly without
        // manual pack selection/submission.
        instructions:
          (baseCtx.pack === autoPackName && baseCtx.instructions && baseCtx.instructions.trim()) ||
          (packCfg && packCfg.instructions) ||
          '',
        policies_markdown:
          (baseCtx.pack === autoPackName && baseCtx.policies_markdown && baseCtx.policies_markdown.trim()) ||
          (packCfg && packCfg.policies) ||
          ''
      };

      const basePayload = {
        step_id: stepId,
        patient_id: pid,
        encounter_id: 'ENC' + pid.slice(1),
        patient: {
          name: p.name,
          ward: p.ward,
          lace: p.lace,
          laceRisk: p.laceRisk,
          hosp: p.hosp,
          hospRisk: p.hospRisk,
          status: p.status,
          atsi: p.atsi,
          ndis: p.ndis
        },
        risk: {
          lace_plus_risk_level: p.laceRisk,
          hospital_risk_level: p.hospRisk
        },
        prompt_pack: promptCtx
      };

      // Hint to backend about the specific agent/intent for this step
      if (stepId === 'step1') basePayload.agent = 'discharge_readiness_risk';
      else if (stepId === 'step2') basePayload.agent = 'medication_reconciliation';
      else if (stepId === 'step3') basePayload.agent = 'followup_orchestration';
      else if (stepId === 'step4') basePayload.agent = 'gp_community_handoff';
      else if (stepId === 'step5') basePayload.agent = 'post_discharge_monitoring';
      else if (stepId === 'step6') basePayload.agent = 'outcomes_analytics';

      const data = await runHealthAgent(kind, basePayload, { append: !!window.__appendMode });

      // For step 3, surface the follow-up booking flow so a user can
      // interactively choose concrete appointment slots where needed.
      if (stepId === 'step3' && data) {
        try {
          openFollowupBookingModal(pid, data);
        } catch (e) {}
      }

      // Prefer backend-provided reasoning if available; otherwise fall back to a simple explanation
      if (data && Array.isArray(data.llm_reasoning)) {
        renderHdLogic(stepId, data);
      } else {
        const fallback = {
          llm_reasoning: [
            'Backend did not return explicit llm_reasoning; showing payload-based context only.'
          ]
        };
        renderHdLogic(stepId, fallback);
      }

      // Update discharge progress for this patient and refresh Status column
      const stepNum = parseInt(String(stepId).replace('step', ''), 10) || 0;
      if (stepNum > 0) {
        window.__hdProgress = window.__hdProgress || {};
        const prev = window.__hdProgress[pid] || 0;
        if (stepNum > prev) window.__hdProgress[pid] = stepNum;
        updateHdStatusForPatient(pid);

        // If Step 2 has just completed for this patient, update the Step 2
        // card status pill from Pending to Completed without reloading cards.
        if (stepId === 'step2') {
          try {
            const stepsEl = document.getElementById('hd_step_cards');
            if (stepsEl) {
              const cards = stepsEl.querySelectorAll('.card');
              cards.forEach(card => {
                if (card.textContent.includes('Step 2') || card.textContent.includes('Med Reconciliation')) {
                  const span = card.querySelector('span.pill');
                  if (span) {
                    span.textContent = 'Completed';
                    span.classList.remove('warn');
                    if (!span.classList.contains('ok')) span.classList.add('ok');
                  }
                }
              });
            }
          } catch (e) {}
        }
      }
      window.__appendMode = true;
      showToast('Executed Hospital Discharge ' + stepId + ' agent.');
    }

    function renderHdLogic(stepId, payload) {
      const el = document.getElementById('hd_llm_logic');
      if (!el) return;
      const lines = (payload && payload.llm_reasoning) || [];
      const header = `Step: ${stepId}\n`;
      if (!lines.length) {
        el.textContent = header + '(No reasoning metadata attached in this demo payload.)';
        return;
      }
      el.textContent = header + lines.map(l => '• ' + l).join('\n');
    }

    function openQuickRun() {
      if (!patientsLoaded) loadPatients();
      openModal('quickRunModal');
    }
    async function runQuickDischargeFlow() {
      const pid = sel('fleet_patient_sel');
      if (!pid) { showToast('Please select a patient'); return; }
      // Navigate and prefill
      goToView('healthAgents');
      const inputs = [
        ['ha_patient', 'ha_patient_sel'],
        ['ha_patient_agentic', 'ha_patient_agentic_sel']
      ];
      inputs.forEach(([inputId, selId]) => {
        const i = document.getElementById(inputId);
        const s = document.getElementById(selId);
        if (i) i.value = pid;
        if (s) s.value = pid;
      });
      // Run Discharge then Agentic Referral, appending second result
      await runHealthAgent('discharge', { patient_id: pid });
      window.__appendMode = true;
      await runHealthAgent('agenticReferral', { patient_id: pid, context: {} });
      closeModal('quickRunModal');
      focusCard('ha_card_discharge');
      // Also surface the selected patient in the Hospital Discharge panel
      try { selectHdPatient(pid); } catch (e) {}
    }

    function formatResult(kind, data) {
      try {
        if (kind === 'discharge' && data) {
          const pid = data?.discharge_event?.data?.patientId || 'unknown';
          const providers = data?.providers?.providers || [];
          const provList = Array.isArray(providers) ? providers.map(p=>p?.name||p?.id).filter(Boolean).slice(0,3).join(', ') : '';
          const notes = (data?.discharge_event?.notes || data?.discharge_event?.data?.notes || '').toString().toLowerCase();
          let risk = 'low';
          if (/sepsis|icu|unstable|critical/.test(notes)) risk = 'high';
          else if (/fall|dizzy|moderate|monitor/.test(notes)) risk = 'moderate';
          return `<p><strong>Discharge prepared</strong> for patient <code>${pid}</code>.</p>` +
                 `<p><strong>Estimated risk:</strong> ${risk}</p>` +
                 (provList ? `<p>Nearby providers: ${provList}…</p>` : '');
        }
        if (kind === 'agenticReferral' && data) {
          const risk = data?.handover?.risk_summary ? `<p><strong>Risk summary for this patient:</strong> ${data.handover.risk_summary}</p>` : '';
          const execT = Array.isArray(data?.executed?.tasks) ? data.executed.tasks : [];
          const execM = Array.isArray(data?.executed?.messages) ? data.executed.messages : [];

          // Turn tasks into a detailed step-by-step narrative including practitioner, due time, and best-guess policy alignment
          const activePol = window.__agenticReferralPolicy;
          const polLines = activePol && activePol.policies_markdown
            ? activePol.policies_markdown.split('\n').map(l => l.trim()).filter(Boolean)
            : [];
          function bestPolicyFor(desc) {
            if (!desc || !polLines.length) return '';
            const d = desc.toLowerCase();
            // Simple heuristics: look for overlapping keywords
            let best = '';
            let bestScore = 0;
            polLines.forEach(line => {
              const l = line.toLowerCase();
              let score = 0;
              ['suicide', 'risk', 'follow-up', 'follow up', 'gp', 'appointment', 'share', 'consent'].forEach(k => {
                if (d.includes(k) && l.includes(k)) score += 1;
              });
              if (score > bestScore) {
                bestScore = score;
                best = line;
              }
            });
            return bestScore > 0 ? best : '';
          }

          const taskLines = execT.map(t => {
            const inp = t?.input || {};
            const owner = inp.owner_ref || 'Unknown practitioner';
            const desc = inp.description || 'Task';
            const due = inp.due_ts || '';
            let when = '';
            try {
              if (due) {
                const d = new Date(due);
                if (!isNaN(d.getTime())) {
                  when = d.toLocaleString('en-AU', { timeZone: 'Australia/Sydney' });
                }
              }
            } catch (e) {}
            const status = (t?.result?.status) ? ` [status: ${t.result.status}]` : '';
            const polHint = bestPolicyFor(desc);
            const hintHtml = polHint ? `<br/>&nbsp;&nbsp;<span style="color:#6b7280; font-size:12px;">(from policy: ${polHint})</span>` : '';
            return `• ${desc} → ${owner}${when ? ' (due ' + when + ')' : ''}${status}${hintHtml}`;
          }).join('<br/>');

          // Messages become explicit sharing actions with purpose and a short content preview
          const msgLines = execM.map(m => {
            const inp = m?.input || {};
            const channel = inp.channel || 'message';
            const to = inp.to_ref || 'Unknown recipient';
            const pou = inp.purpose_of_use || '';
            const status = (m?.result?.status) ? ` [status: ${m.result.status}]` : '';
            let content = inp.content || '';
            if (content.length > 140) content = content.slice(0, 140) + '…';
            return `• ${channel} to ${to}${pou ? ' (' + pou + ')' : ''}${status}<br/>&nbsp;&nbsp;“${content || 'no content'}”`;
          }).join('<br/>');

          const gpMsg = data?.gp_message ? `<p><strong>Practitioner communication content:</strong> ${data.gp_message}</p>` : '';
          const allowed = Array.isArray(data?.share_result?.allowed) ? data.share_result.allowed : [];
          const denied = Array.isArray(data?.share_result?.denied) ? data.share_result.denied : [];
          const allowLines = allowed.map(a => `• ${a.type}: ${a.to_ref || a.owner_ref || ''} (${a.purpose_of_use || a.description || ''})`).join('<br/>');
          const denyLines = denied.map(a => `• ${a.type}: ${a.to_ref || a.owner_ref || ''} – denied${a.reason? ' ('+a.reason+')':''}`).join('<br/>');

          // Surface the active policy snippet that influenced this referral, if any
          let policyHtml = '';
          let policyExplainHtml = '';
          try {
            const pol = window.__agenticReferralPolicy;
            if (pol && pol.policies_markdown) {
              const lines = pol.policies_markdown
                .split('\n')
                .map(l => l.trim())
                .filter(Boolean);
              if (lines.length) {
                const body = lines.map(l => `• ${l}`).join('<br/>');
                const raw = pol.policies_markdown;
                policyHtml = `<p><strong>Applied policies (${pol.pack || 'Custom'}):</strong><br/>${body}</p>` +
                             (raw ? `<pre style="margin-top:4px; padding:6px; background:#f9fafb; border-radius:4px; white-space:pre-wrap;">${raw}</pre>` : '');

                const totalTasks = execT.length;
                const totalMsgs = execM.length;
                const allowedCount = allowed.length;
                const deniedCount = denied.length;
                policyExplainHtml =
                  `<p><strong>How policies affected this patient:</strong><br/>` +
                  `For this patient, the planner created ${totalTasks} task(s) and ${totalMsgs} message(s). ` +
                  (allowedCount || deniedCount
                    ? `Policies allowed ${allowedCount} action(s) and blocked ${deniedCount} action(s) based on purpose of use and recipient.`
                    : `All actions were evaluated against the submitted policies; none were explicitly blocked.`) +
                  `</p>`;
              }
            }
          } catch {}

          return `<p><strong>Agentic referral executed.</strong></p>` +
                 risk +
                 policyHtml +
                 policyExplainHtml +
                 (taskLines ? `<p><strong>Planned and executed tasks:</strong><br/>${taskLines}</p>` : '') +
                 (msgLines ? `<p><strong>Notifications and information sharing:</strong><br/>${msgLines}</p>` : '') +
                 gpMsg +
                 (allowLines ? `<p><strong>Sharing allowed:</strong><br/>${allowLines}</p>` : '') +
                 (denyLines ? `<p><strong>Sharing denied:</strong><br/>${denyLines}</p>` : '');
        }
        if (kind === 'consent' && data) {
          const decision = data?.decision;
          const allowed = Array.isArray(data?.allowed) ? data.allowed : [];
          const denied = Array.isArray(data?.denied) ? data.denied : [];
          const why = data?.reason || data?.restrictions || '';

          let headline = 'unknown';
          let policyRefs = [];
          if (typeof decision === 'object' && decision) {
            const allowedFlag = decision.allowed;
            if (allowedFlag === true) headline = 'sharing allowed';
            else if (allowedFlag === false) headline = 'sharing not allowed';
            else headline = JSON.stringify(decision);
            if (Array.isArray(decision.policy_refs)) policyRefs = decision.policy_refs;
          } else if (typeof decision === 'string') {
            headline = decision;
          }

          let html = `<p><strong>Consent decision:</strong> ${headline}</p>`;
          if (policyRefs.length) {
            html += `<p><strong>Applied policies:</strong> ${policyRefs.join(', ')}</p>`;
          }
          if (allowed.length) {
            html += `<p><strong>Sharing allowed for:</strong><br/>` +
                    allowed.map(a => `• ${a}`).join('<br/>') + '</p>';
          }
          if (denied.length) {
            html += `<p><strong>Not allowed for:</strong><br/>` +
                    denied.map(a => `• ${a}`).join('<br/>') + '</p>';
          }
          if (why) {
            html += `<p><strong>Why:</strong> ${typeof why==='string'? why : JSON.stringify(why)}</p>`;
          }
          return html;
        }
        if (kind === 'uber' && data) {
          const b = data?.booking || {};
          return `<p><strong>Uber booking</strong> ${b.id || ''} ${b.status ? 'is '+b.status : ''}.</p>` +
                 (b.eta_min ? `<p>ETA: ${b.eta_min} min</p>` : '') +
                 (b.driver?.name ? `<p>Driver: ${b.driver.name} (${b.driver.rating||''})</p>` : '');
        }

        // Hospital Discharge steps: narrate JSON result in natural language
        if (kind && kind.startsWith('hd_step') && data) {
          const res = data.result || data;
          const pid = res.patient_id || data.patient_id || 'this patient';
          const agent = res.agent || data.agent || '';
          const risk = res.overall_risk_band || res.risk_band || res.risk?.overall || data.risk?.overall_risk_band;
          const bundle = res.recommended_bundle || res.bundle || '';
          const v = (x, fallback) => (x === undefined || x === null || x === '') ? fallback : x;

          let intro = '';
          if (kind === 'hd_step1') {
            intro = `The Discharge Readiness & Risk agent has assessed patient <code>${pid}</code>. ` +
                    `It classifies their overall discharge risk as <strong>${v(risk,'UNKNOWN')}</strong>` +
                    (bundle ? ` and recommends the <strong>${bundle}</strong> discharge bundle.` : '.');
          } else if (kind === 'hd_step2') {
            const recon = res.reconciliation || {};
            const contArr = Array.isArray(recon.continued) ? recon.continued : [];
            const startedArr = Array.isArray(recon.started) ? recon.started : [];
            const stoppedArr = Array.isArray(recon.stopped) ? recon.stopped : [];
            const cont = contArr.length;
            const started = startedArr.length;
            const stopped = stoppedArr.length;

            function medLabel(m) {
              const name = m.medication_name || m.name || 'Medication';
              const dose = m.dose || '';
              const route = m.route || '';
              const freq = m.frequency || '';
              const bits = [name];
              if (dose) bits.push(dose);
              if (route) bits.push(route);
              if (freq) bits.push(freq);
              return bits.join(' · ');
            }

            const contList = contArr.map(m => `• ${medLabel(m)}`).join('<br/>');
            const startedList = startedArr.map(m => `• ${medLabel(m)}`).join('<br/>');
            const stoppedList = stoppedArr.map(m => `• ${medLabel(m)}`).join('<br/>');

            // Surface high-risk medicines explicitly, aligned with Prompt Studio
            // policy: "Always flag high-risk medicines (anticoagulants, insulin,
            // opioids) for explicit counselling."
            const highRiskTerms = ['insulin', 'warfarin', 'heparin', 'apixaban', 'rivaroxaban', 'anticoagulant', 'opioid', 'morphine', 'oxycodone', 'fentanyl'];
            function isHighRiskName(name) {
              if (!name) return false;
              const lower = String(name).toLowerCase();
              return highRiskTerms.some(t => lower.includes(t));
            }
            const allMeds = [...contArr, ...startedArr, ...stoppedArr];
            const highRiskMeds = allMeds.filter(m => isHighRiskName(m.medication_name || m.name));
            const highRiskLines = highRiskMeds.map(m => `• ${medLabel(m)}`).join('<br/>');
            const eduPoints = Array.isArray(recon.education_points) ? recon.education_points : [];
            const eduHtml = eduPoints.length
              ? `<p><strong>Education and counselling points:</strong><br/>${eduPoints.map(e => `• ${e}`).join('<br/>')}</p>`
              : '';

            intro = `The Medication Reconciliation agent has compared home, in-hospital, and proposed discharge medicines for <code>${pid}</code>. ` +
                    `It will continue <strong>${cont}</strong> medicine(s), start <strong>${started}</strong>, and stop <strong>${stopped}</strong>, highlighting important education points for the patient.` +
                    (contList ? `<p><strong>Continued medicines:</strong><br/>${contList}</p>` : '') +
                    (startedList ? `<p><strong>New medicines to start:</strong><br/>${startedList}</p>` : '') +
                    (stoppedList ? `<p><strong>Medicines to stop:</strong><br/>${stoppedList}</p>` : '') +
                    (highRiskLines ? `<p><strong>High-risk medicines flagged for explicit counselling (per policy):</strong><br/>${highRiskLines}</p>` : '') +
                    eduHtml;
          } else if (kind === 'hd_step3') {
            const fups = Array.isArray(res.required_followups) ? res.required_followups : [];
            let missing = fups.filter(f => f.status === 'MISSING').length;
            let scheduled = fups.filter(f => f.status === 'ALREADY_SCHEDULED').length;
            let created = fups.filter(f => f.status === 'CREATED').length;

            const raw = res.plan_raw || {};
            const appts = raw.follow_up_plan && Array.isArray(raw.follow_up_plan.appointments)
              ? raw.follow_up_plan.appointments
              : [];

            // If the structured follow-up list is empty but the raw plan contains
            // appointments, treat those as already scheduled.
            if (!fups.length && appts.length) {
              scheduled = appts.length;
              missing = 0;
            }

            const allAppts = fups.length
              ? fups.map(a => ({
                  type: a.type || 'follow-up appointment',
                  status: a.status || '',
                  timeframe: a.recommended_timeframe || '',
                  channel: a.channel || '',
                  appointmentDateTime: a.appointment_date_time || '',
                }))
              : appts.map(a => ({
                  type: a.type || 'follow-up appointment',
                  status: a.status || 'ALREADY_SCHEDULED',
                  timeframe: a.date || '',
                  channel: a.channel || '',
                  appointmentDateTime: a.date || '',
                }));

            const apptLines = allAppts.map(a => {
              const bits = [a.type];
              let whenLabel = '';
              try {
                const raw = a.appointmentDateTime || a.timeframe || '';
                if (raw) {
                  const d = new Date(raw);
                  if (!isNaN(d.getTime())) {
                    whenLabel = d.toLocaleString('en-AU', {
                      timeZone: 'Australia/Sydney',
                      weekday: 'short',
                      day: '2-digit',
                      month: 'short',
                      year: 'numeric',
                      hour: '2-digit',
                      minute: '2-digit'
                    });
                  } else {
                    whenLabel = raw;
                  }
                }
              } catch (e) {
                whenLabel = a.timeframe || '';
              }
              if (whenLabel) bits.push(whenLabel);
              if (a.channel) bits.push(a.channel);
              if (a.status) bits.push(`status: ${a.status}`);
              return `• ${bits.join(' · ')}`;
            }).join('<br/>');

            let safetyLine = '';
            try {
              const sp = raw.follow_up_plan && raw.follow_up_plan.safety_plan;
              const ra = raw.risk_assessment || {};
              const spStatus = ra.safety_plan_status || (typeof sp === 'string' ? sp : '');
              if (spStatus) {
                safetyLine = `<p><strong>Safety plan status:</strong> ${spStatus}</p>`;
              }
            } catch (e) {}

            // Surface any newly CREATED follow-up appointments (Task-backed)
            // explicitly, including date/time and reason, rather than only
            // describing the first scheduled appointment.
            let bookingLine = '';
            try {
              const createdFups = fups.filter(f => f.status === 'CREATED');
              if (createdFups.length) {
                const createdLines = createdFups.map(f => {
                  const t = f.type || 'follow-up appointment';
                  const reason = f.reason || '';
                  const raw = f.appointment_date_time || f.recommended_timeframe || '';
                  let when = '';
                  try {
                    if (raw) {
                      const d = new Date(raw);
                      if (!isNaN(d.getTime())) {
                        when = d.toLocaleString('en-AU', {
                          timeZone: 'Australia/Sydney',
                          weekday: 'short',
                          day: '2-digit',
                          month: 'short',
                          year: 'numeric',
                          hour: '2-digit',
                          minute: '2-digit'
                        });
                      } else {
                        when = raw;
                      }
                    }
                  } catch (e) {
                    when = raw || '';
                  }
                  const taskId = f.task_id || '';
                  let line = `<strong>${t}</strong>`;
                  if (when) line += ` on <strong>${when}</strong>`;
                  if (reason) line += ` because: ${reason}`;
                  if (taskId) line += ` (Task ID: ${taskId})`;
                  return `• ${line}`;
                }).join('<br/>');
                bookingLine = `<p><strong>Newly created follow-up appointments:</strong><br/>${createdLines}</p>`;
              }
            } catch (e) {}

            intro = `The Follow-Up Orchestration agent has reviewed which appointments <code>${pid}</code> needs after discharge. ` +
                    `It identifies <strong>${scheduled}</strong> appointment(s) already scheduled, <strong>${created}</strong> appointment(s) created in this run, and <strong>${missing}</strong> still to be booked.` +
                    (apptLines ? `<p><strong>Follow-up appointments:</strong><br/>${apptLines}</p>` : '') +
                    bookingLine +
                    safetyLine;
          } else if (kind === 'hd_step4') {
            const gp = res.gp_handoff || {};
            const summaryArr = Array.isArray(gp.summary_bullets) ? gp.summary_bullets : [];
            const bullets = summaryArr.length;
            const actionsArr = Array.isArray(gp.gp_action_items) ? gp.gp_action_items : [];
            const referralsArr = Array.isArray(gp.community_referrals) ? gp.community_referrals : [];

            function gpActionLabel(a) {
              if (!a) return '';
              // gp_action_items may be simple strings or richer objects
              if (typeof a === 'string') {
                return a.trim();
              }
              const desc = a.description || a.summary || '';
              let prov = a.provider || a.gp || '';
              if (Array.isArray(prov)) {
                // Sometimes provider comes through as an array of rich-text spans,
                // e.g. [{ text: "Case Manager Kim" }]. Render this cleanly.
                prov = prov
                  .map(p => (p && (p.text || p.name || p.id || '')).trim())
                  .filter(Boolean)
                  .join(', ');
              } else if (prov && typeof prov === 'object') {
                prov = prov.name || prov.text || prov.id || '';
              }
              const when = a.when || a.timeframe || a.due || a.scheduled_time || '';
              const bits = [];
              if (desc) bits.push(desc);
              if (prov) bits.push(`with ${prov}`);
              if (when) bits.push(when);
              return bits.join(' · ').trim();
            }

            const summaryLines = summaryArr.map(b => `• ${b}`).join('<br/>');
            const seenGp = new Set();
            const gpLines = actionsArr
              .map(a => gpActionLabel(a))
              .filter(line => {
                if (!line) return false;
                if (line.toLowerCase() === 'gp follow-up') return false; // skip placeholder-only entries
                if (seenGp.has(line)) return false;
                seenGp.add(line);
                return true;
              })
              .map(line => `• ${line}`).join('<br/>');
            const refLines = referralsArr.map(r => {
              const type = r.type || r.service || 'Referral';
              const dest = r.to || r.organization || '';
              const when = r.when || r.timeframe || '';
              const bits = [type];
              if (dest) bits.push(`to ${dest}`);
              if (when) bits.push(when);
              return `• ${bits.join(' · ')}`;
            }).join('<br/>');

            const actions = actionsArr.length;
            intro = `The GP & Community Handoff agent has generated a structured handover for patient <code>${pid}</code>. ` +
                    `It includes <strong>${bullets}</strong> key summary point(s) and <strong>${actions}</strong> GP action item(s), plus any required community referrals.` +
                    (summaryLines ? `<p><strong>Key summary points for GP:</strong><br/>${summaryLines}</p>` : '') +
                    (gpLines ? `<p><strong>GP follow-up actions:</strong><br/>${gpLines}</p>` : '') +
                    (refLines ? `<p><strong>Community referrals:</strong><br/>${refLines}</p>` : '');
          } else if (kind === 'hd_step5') {
            const nc = res.next_check_in || {};
            const ch = nc.channel || 'APP';
            const qsArr = Array.isArray(nc.questions) ? nc.questions : [];
            const qs = qsArr.length;
            const alertArr = Array.isArray(nc.alert_rules) ? nc.alert_rules : [];

            const qLines = qsArr.map(q => `• ${q}`).join('<br/>');
            const alertLines = alertArr.map(a => `• ${a}`).join('<br/>');

            intro = `The Post-Discharge Monitoring agent has planned the next check-in for <code>${pid}</code>. ` +
                    `It proposes a <strong>${ch}</strong> check-in with <strong>${qs}</strong> tailored question(s) and will raise alerts if concerning responses appear.` +
                    (qLines ? `<p><strong>Monitoring questions:</strong><br/>${qLines}</p>` : '') +
                    (alertLines ? `<p><strong>Escalation rules:</strong><br/>${alertLines}</p>` : '');
          } else if (kind === 'hd_step6') {
            const period = res.dashboard_period || {};
            const start = period.start_date || 'the current period';
            const kpis = res.kpis || {};
            // Turn KPI object into human-readable bullet list
            const lines = [];
            const mapLabel = key => {
              const lower = key.toLowerCase();
              if (lower.includes('readmission')) return '30-day readmission rate';
              if (lower.includes('follow') && lower.includes('7')) return 'GP follow-up within 7 days';
              if (lower.includes('med') && lower.includes('recon')) return 'Medication reconciliation completion';
              if (lower.includes('los') || lower.includes('length_of_stay')) return 'Average length of stay';
              return key;
            };
            Object.keys(kpis || {}).forEach(k => {
              const label = mapLabel(k);
              const v = kpis[k];
              if (v !== undefined && v !== null && v !== '') {
                lines.push(`• ${label}: ${v}`);
              }
            });
            const kpiHtml = lines.length
              ? `<p><strong>Key performance indicators for this discharge program:</strong><br/>${lines.join('<br/>')}</p>`
              : '';

            intro = `The Outcomes & Governance Analytics agent has updated cohort metrics for patient <code>${pid}</code> over <strong>${start}</strong> to <strong>${period.end_date || ''}</strong>. ` +
                    `It summarises readmission, follow-up completion, medication reconciliation, and length-of-stay performance for this discharge program.` +
                    kpiHtml;
          }

          return `<p>${intro}</p>`;
        }
      } catch {}
      const safe = (data !== undefined) ? data : null;
      const pretty = (() => {
        try { return JSON.stringify(safe, null, 2); } catch { return String(safe); }
      })();
      return `<p><strong>Result:</strong></p><pre style="white-space:pre-wrap; background:#f9fafb; border-radius:4px; padding:6px;">${pretty}</pre>`;
    }

    function formatCooResult(kind, data) {
      try {
        const res = data && (data.result || data.output || data);
        const artifacts = Array.isArray(data && data.artifacts) ? data.artifacts : [];
        const tool = (res && res.tool) || `coo.${kind}`;
        const out = (res && (res.output || res.summary || res.result)) || res || {};
        const summary = out.summary || (typeof out === 'string' ? out : 'CoO flow completed.');
        let html = `<p><strong>${tool}</strong></p><p>${summary}</p>`;

        // Domain-specific hints per flow
        if (tool === 'coo.address-standardize') {
          html += '<p>This run inspects Property.csv and prepares a cleaned view of property addresses that downstream agents can consume.</p>';
        } else if (tool === 'coo.ownership') {
          html += '<p>This approximates a change-of-ownership run, correlating ownership history with the current property table to show how many properties would be impacted.</p>';
        } else if (tool === 'coo.ownership-deterministic') {
          html += '<p>This simulates a deterministic ownership apply, useful for replaying a known scenario without LLM routing.</p>';
        } else if (tool === 'coo.special-read') {
          html += '<p>This represents the special-read scheduler, turning trigger rows into a planned meter-read schedule CSV that a field ops agent could act on.</p>';
        } else if (tool === 'coo.bill-transfer') {
          html += '<p>This represents a bill-transfer pass, combining the current billing snapshot with any transfer rows to produce a bill file an agent could send or escalate.</p>';
        } else if (tool === 'coo.reset') {
          html += '<p>This is a no-op reset in the shared-data demo: it reports which core CSVs are present rather than mutating them.</p>';
        }
        if (typeof out.history_rows === 'number' || typeof out.property_rows === 'number') {
          const h = out.history_rows != null ? out.history_rows : '?';
          const p = out.property_rows != null ? out.property_rows : '?';
          html += `<p>History rows: ${h}, Property rows: ${p}.</p>`;
        }
        if (typeof out.triggers === 'number' || typeof out.scheduled_reads === 'number') {
          const t = out.triggers != null ? out.triggers : '?';
          const s = out.scheduled_reads != null ? out.scheduled_reads : '?';
          html += `<p>Special read triggers: ${t}, scheduled reads: ${s}.</p>`;
        }
        if (typeof out.billing_rows === 'number' || typeof out.transfer_rows === 'number') {
          const b = out.billing_rows != null ? out.billing_rows : '?';
          const tr = out.transfer_rows != null ? out.transfer_rows : '?';
          html += `<p>Billing rows: ${b}, transfer rows: ${tr}.</p>`;
        }
        if (Array.isArray(out.sample_properties) && out.sample_properties.length) {
          html += `<p><strong>Sample properties:</strong> showing ${out.sample_properties.length} of ${out.total_properties || ''}.</p>`;
        }
        if (artifacts.length) {
          const list = artifacts.map(a => `• ${a.name} (${a.type})`).join('<br/>');
          html += `<p><strong>Artifacts:</strong><br/>${list}</p>`;
        }
        return html;
      } catch (e) {
        return '<p>CoO result available.</p>';
      }
    }

    // ---- Follow-up booking helpers (Step 3) ----

    function openFollowupBookingModal(patientId, stepData) {
      const res = stepData.result || stepData;
      const fups = Array.isArray(res.required_followups) ? res.required_followups : [];

      // Consider any follow-up that is not already scheduled as needing a
      // booking interaction.
      const needing = fups.filter(f => (f.status || '').toUpperCase() !== 'ALREADY_SCHEDULED');
      if (!needing.length) return; // nothing to book

      const bodyEl = document.getElementById('followupBookingBody');
      if (!bodyEl) return;

      const encId = res.encounter_id || ('ENC' + String(patientId || '').slice(1));
      const items = needing.map((f, idx) => ({
        idx,
        type: f.type || 'appointment',
        provider_id: f.provider_id || '',
        reason: f.reason || '',
        recommended_timeframe: f.recommended_timeframe || ''
      }));

      window.__followupBookingCtx = {
        patientId,
        encounterId: encId,
        items
      };

      const today = new Date().toISOString().slice(0, 10);
      const sections = items.map(item => {
        const idSuffix = String(item.idx);
        const tf = item.recommended_timeframe ? ` (recommended: ${item.recommended_timeframe})` : '';
        return `
          <div class="card" style="margin-bottom:8px;">
            <h4 style="margin:4px 0 6px;">${item.type}</h4>
            <p style="font-size:12px; color:var(--muted);">${item.reason || 'Follow-up required.'}${tf}</p>
            <div class="row" style="margin-bottom:6px;">
              <div style="flex:1;">
                <label>Choose date</label>
                <input type="date" id="followup_date_${idSuffix}" value="${today}" onchange="onFollowupDateChange(${item.idx})" />
              </div>
            </div>
            <div>
              <label>Available 15-minute slots</label>
              <div id="followup_slots_${idSuffix}" class="row" style="flex-wrap:wrap; gap:4px; font-size:12px;"></div>
            </div>
          </div>
        `;
      }).join('');

      bodyEl.innerHTML = sections;

      // Preload slots for each follow-up using today's date
      items.forEach(item => {
        try { onFollowupDateChange(item.idx); } catch (e) {}
      });

      openModal('followupBookingModal');
    }

    async function onFollowupDateChange(idx) {
      const ctx = window.__followupBookingCtx;
      if (!ctx) return;
      const item = ctx.items.find(i => i.idx === idx);
      if (!item) return;
      const dateEl = document.getElementById('followup_date_' + idx);
      const slotsEl = document.getElementById('followup_slots_' + idx);
      if (!dateEl || !slotsEl) return;
      const date = dateEl.value || new Date().toISOString().slice(0, 10);

      slotsEl.innerHTML = '<span style="font-size:12px; color:var(--muted);">Loading slots…</span>';

      try {
        const resp = await fetch((HEALTH_API.baseUrl || '') + '/demo/followups/slots', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            patient_id: ctx.patientId,
            appointment_type: item.type,
            provider_id: item.provider_id || undefined,
            date
          })
        });
        const data = await resp.json();
        const slots = Array.isArray(data.slots) ? data.slots : [];
        if (!slots.length) {
          slotsEl.innerHTML = '<span style="font-size:12px; color:var(--muted);">No slots available for this day.</span>';
          return;
        }

        slotsEl.innerHTML = '';
        slots.forEach(s => {
          const d = new Date(s.start);
          const label = isNaN(d.getTime())
            ? s.start
            : d.toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit' });
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'btn';
          btn.textContent = label;
          btn.style.marginBottom = '4px';
          btn.disabled = !!s.busy;
          if (s.busy) {
            btn.classList.add('ghost');
            btn.style.opacity = '0.5';
            btn.title = 'Busy';
          }
          btn.onclick = () => {
            // Record selection
            item.selectedDatetime = s.start;
            // Visual highlight
            Array.from(slotsEl.querySelectorAll('button')).forEach(b => b.classList.remove('primary'));
            btn.classList.add('primary');
          };
          slotsEl.appendChild(btn);
        });
      } catch (e) {
        slotsEl.innerHTML = '<span style="font-size:12px; color:var(--err);">Error loading slots.</span>';
      }
    }

    async function confirmFollowupBookings() {
      const ctx = window.__followupBookingCtx;
      if (!ctx) { closeModal('followupBookingModal'); return; }
      const toBook = ctx.items
        .filter(i => i.selectedDatetime)
        .map(i => ({
          type: i.type,
          datetime: i.selectedDatetime,
          provider_id: i.provider_id || undefined,
          reason: i.reason || undefined
        }));

      if (!toBook.length) {
        showToast('Select at least one slot before confirming.');
        return;
      }

      try {
        const resp = await fetch((HEALTH_API.baseUrl || '') + '/demo/followups/book', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            patient_id: ctx.patientId,
            encounter_id: ctx.encounterId,
            bookings: toBook
          })
        });
        const data = await resp.json();
        const summary = data.summary_text || 'Follow-up appointments booked.';
        showToast(summary);
      } catch (e) {
        showToast('Error booking follow-up appointments.');
      }

      closeModal('followupBookingModal');
    }

    function focusCard(id) {
      const el = document.getElementById(id);
      if (!el) return;
      goToView('healthAgents');
      el.scrollIntoView({ behavior: 'smooth', block: 'center' });
      el.classList.add('focus-glow');
      setTimeout(()=> el.classList.remove('focus-glow'), 1200);
    }

    function goToAgent(name) {
      document.getElementById('agentTitle').textContent = name || 'Balance Transfer Agent';
      goToView('agent');
    }
    function goToAgentWithCase() {
      goToAgent('Balance Transfer Agent');
      showToast('Loaded case context into Behaviour tab');
    }

    // Agent Detail domain-aware configuration (Billing vs Health)
    const AGENT_DETAIL_META = {
      billing: {
        title: 'Balance Transfer Agent',
        subtitle: 'Billing Domain  b7 Change of Ownership',
        systemPrompt: 'You are a reliable agent for SA Water billing operations. Follow policies and ensure customer protections.',
        domainLabel: 'Domain Prompt (Billing)',
        domainPrompt: 'Billing domain norms: apply hardship and vulnerable-customer protections prioritising continuity of service.',
        processLabel: 'Process Prompt (Change of Ownership)',
        processPrompt: 'When handling Change of Ownership, ensure balances are transferred fairly, avoiding wrongful disconnections where payment plans exist.',
        envOverrides: 'Prod-only guardrails enabled. Log all disconnection intents for manual review.',
        scenarios: [
          'Disconnection with Active Payment Plan',
          'Final Bill with Credit Balance',
          'Move-In with Pending Special Read'
        ],
        previousBehaviour: 'Recommended disconnection despite active payment plan (low confidence).',
        desiredBehaviour: 'Keep service connected, notify customer, and schedule follow-up; never disconnect vulnerable customers.'
      },
      health: {
        title: 'Agentic Referral (Health)',
        subtitle: 'Health Domain  b7 Referral & Consent',
        systemPrompt: 'You are a care orchestration planner for Australian health services. Use clinical, consent, and policy context to plan safe follow-up.',
        domainLabel: 'Domain Prompt (Health Agents)',
        domainPrompt: 'Health domain norms: respect Australian health privacy regulations, consent policies, and suicide risk safeguards when planning referrals.',
        processLabel: 'Process Prompt (Agentic Referral & Consent)',
        processPrompt: 'For discharge and referral workflows, ensure follow-up appointments, community referrals, and consent-aware sharing decisions are created.',
        envOverrides: 'In this demo, LLM decisions are logged and surfaced for review. Do not treat outputs as clinical advice.',
        scenarios: [
          'Suicide risk discharge follow-up (no safety plan documented)',
          'Routine post-discharge GP follow-up',
          'Community mental health referral after medication change'
        ],
        previousBehaviour: 'Created a single generic follow-up without highlighting suicide risk or consent constraints.',
        desiredBehaviour: 'Schedule appropriate follow-ups (e.g., multiple GP and community MH appointments) and clearly explain how consent and policies shaped sharing.'
      }
    };

    function applyAgentDetailDomain(domain) {
      const meta = AGENT_DETAIL_META[domain] || AGENT_DETAIL_META.billing;
      const titleEl = document.getElementById('agentTitle');
      const subtitleEl = document.getElementById('agentSubtitle');
      const systemTextarea = document.querySelector('#agent textarea[readonly]');
      const domainLabelEl = document.querySelector("label[for='domainPrompt']") || document.querySelector("label:contains('Domain Prompt')");
      const processLabelEl = document.querySelector("label[for='processPrompt']") || document.querySelector("label:contains('Process Prompt')");
      const domainTa = document.getElementById('domainPrompt');
      const processTa = document.getElementById('processPrompt');
      const envTa = document.getElementById('envOverrides');
      const scenSel = document.getElementById('scenarioSelect');
      const prevTa = document.querySelector("label:contains('Agent’s Previous Behaviour') + textarea, label:contains('Agent\u2019s Previous Behaviour') + textarea") || null;
      const desiredTa = document.getElementById('desiredBehaviour');

      if (titleEl) titleEl.textContent = meta.title;
      if (subtitleEl) subtitleEl.textContent = meta.subtitle;
      if (systemTextarea) systemTextarea.value = meta.systemPrompt;
      if (domainLabelEl) domainLabelEl.textContent = meta.domainLabel;
      if (processLabelEl) processLabelEl.textContent = meta.processLabel;
      if (domainTa) domainTa.value = meta.domainPrompt;
      if (processTa) processTa.value = meta.processPrompt;
      if (envTa) envTa.value = meta.envOverrides;
      if (scenSel && Array.isArray(meta.scenarios)) {
        while (scenSel.options.length) scenSel.remove(0);
        meta.scenarios.forEach(s => {
          const opt = document.createElement('option');
          opt.textContent = s;
          scenSel.appendChild(opt);
        });
      }
      if (prevTa) prevTa.value = meta.previousBehaviour;
      if (desiredTa) desiredTa.value = meta.desiredBehaviour;

      const sel = document.getElementById('agentDomain');
      if (sel) sel.value = domain;
    }

    // Env selector + LLM status
    const envChips = document.querySelectorAll('.env .chip');
    const envLabel = document.getElementById('envLabel');

    async function updateLlmStatus() {
      const llmStatusEl = document.getElementById('llmStatus');
      const llmDotEl = document.getElementById('llmDot');
      if (!llmStatusEl) return;
      try {
        const res = await fetch((HEALTH_API.baseUrl || '') + '/llm-info');
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const info = await res.json();
        const provider = info.provider || 'mock';
        const model = info.model || '';
        const isMock = provider === 'mock' || info.is_mock === true;
        const label = isMock
          ? 'LLM: mock'
          : 'LLM: ' + provider + (model ? ' • ' + model : '');
        llmStatusEl.textContent = label;
        if (llmDotEl) {
          if (isMock) {
            llmDotEl.style.background = '#e5e7eb';  // grey for mock
            llmDotEl.style.borderColor = '#d1d5db';
          } else {
            llmDotEl.style.background = '#22c55e';  // green when real LLM reachable
            llmDotEl.style.borderColor = '#16a34a';
          }
        }
      } catch (e) {
        llmStatusEl.textContent = 'LLM: unknown';
        if (llmDotEl) {
          llmDotEl.style.background = '#f97373';  // red-ish on error/unknown
          llmDotEl.style.borderColor = '#b91c1c';
        }
      }
    }

    // Call once on script load in case DOMContentLoaded has already fired
    updateLlmStatus();

    envChips.forEach(ch => ch.addEventListener('click', () => {
      envChips.forEach(x => x.classList.remove('active'));
      ch.classList.add('active');
      const env = ch.dataset.env;
      if (envLabel) envLabel.textContent = env;
      // Swap base URL per environment (customise as needed)
      if (env === 'Prod') {
        AGENTS_EXEC.baseUrl = 'http://localhost:8000';
        HEALTH_API.baseUrl = 'http://127.0.0.1:8001';
      } else if (env === 'UAT') {
        AGENTS_EXEC.baseUrl = 'http://localhost:8001';
        HEALTH_API.baseUrl = 'http://127.0.0.1:8001';
      } else {
        AGENTS_EXEC.baseUrl = 'http://localhost:8002';
        HEALTH_API.baseUrl = 'http://127.0.0.1:8001';
      }
      showToast('Environment set to ' + env + ' • Exec base ' + AGENTS_EXEC.baseUrl);
    }));

    // Autonomy slider display
    const autonomy = document.getElementById('autonomy');
    const autonomyVal = document.getElementById('autonomyVal');
    if (autonomy) autonomy.addEventListener('input', () => autonomyVal.textContent = autonomy.value);

    // Tabs logic
    function initTabs(group) {
      const tabs = document.querySelectorAll('.tabs[data-tabs="' + group + '"] .tab');
      const panes = document.querySelectorAll('.tabpanes[data-tabpanes="' + group + '"] .tabpane');
      tabs.forEach((tab, idx) => tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        panes.forEach(p => p.classList.remove('active'));
        tab.classList.add('active');
        panes[idx].classList.add('active');
        if (group === 'studio-tabs' && tab.textContent === 'Context') {
          loadContextList();
        }
      }));
    }
    initTabs('agent-tabs');
    initTabs('studio-tabs');

    // Toast helper
    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.style.display = 'block';
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(() => { t.style.display = 'none'; }, 2200);
    }

    // Review modal
    function openReview(ctx) {
      if (ctx) document.getElementById('reviewContext').textContent = ctx;
      openModal('reviewModal');
    }

    // Generic modal helpers
    function openModal(id) { document.getElementById(id).style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }

    // Edit modal wiring
    let __editTarget = null;
    function openEdit(title, targetId) {
      __editTarget = document.getElementById(targetId);
      document.getElementById('editTitle').textContent = title;
      document.getElementById('editTextarea').value = __editTarget ? __editTarget.value : '';
      document.getElementById('editLabel').textContent = title;
      openModal('editModal');
    }
    function saveDraft() {
      if (__editTarget) {
        __editTarget.value = document.getElementById('editTextarea').value;
      }
      closeModal('editModal');
      showToast('Draft prompt saved to Agent Definition v1.7.3 (not deployed).');
    }
    function discardEdit() {
      closeModal('editModal');
      showToast('Discarded changes');
    }

    // Prompt Studio pack switching (mock)
    const packList = document.getElementById('packList');
    const packTitle = document.getElementById('packTitle');
    const packDesc = document.getElementById('packDesc');
    const packAffects = document.getElementById('packAffects');
    const policyText = document.getElementById('policyText');
    const packInstructions = document.getElementById('packInstructions');
    const studioDomain = document.getElementById('studioDomain');
    const ctxPackHint = document.getElementById('ctxPackHint');

    const PACK_META = {
      'SA Water  CoO Core v1.3': {
        domain: 'water',
        desc: 'Core prompts for Change of Ownership across SA Water.',
        affects: 'Change-of-Ownership Agent d Billing Agent d Special Read Scheduler Agent',
        instructions: 'Core behaviour for SA Water Change of Ownership flows. Ensure address standardisation, correct ownership mapping, and safe handling of vulnerable customers.',
        policies: [
          'Never disconnect vulnerable customers without human approval.',
          'Always respect active payment plans.',
          'Log and justify any service interruption intent.',
        ].join('\n- '),
        contextHint: 'Use CoO specs, integrations, and vulnerable customer handling constraints for this pack.',
        contextPrefixes: ['specs/water', 'architecture/water', 'integrations/water', 'constraints/water'],
      },
      'SA Water  Vulnerable Customer Handling v1.1': {
        domain: 'water',
        desc: 'Guidance to protect vulnerable customers during billing and change-of-ownership flows.',
        affects: 'Balance Transfer Agent d Ownership Trigger Agent d Special Read Scheduler Agent',
        instructions: 'When a customer is flagged as vulnerable, prioritise continuity of service, hardship options, and human review over automated disconnection.',
        policies: [
          'Never disconnect vulnerable customers without human approval.',
          'Always respect active payment plans.',
          'Log and justify any service interruption intent.',
        ].join('\n- '),
        contextHint: 'Use vulnerable customer handling specs and billing constraints to evaluate this pack.',
        contextPrefixes: ['specs/water', 'constraints/water'],
      },
      'GWW  Grange Billing Twin v0.9': {
        domain: 'water',
        desc: 'Twin prompts for Grange Billing test environment.',
        affects: 'Billing Twin Agent d Statement Generation Agent',
        instructions: 'Keep the billing twin aligned with the Grange test environment; highlight any divergence between expected and observed bill calculations.',
        policies: [
          'Always reconcile bills against the source-of-truth billing system.',
          'Flag and escalate any discrepancies in vulnerable customer accounts.',
        ].join('\n- '),
        contextHint: 'Use Grange billing specs and integration notes as context for this pack.',
        contextPrefixes: ['specs/grange', 'integrations/grange'],
      },
      'Australian Health Privacy Regulations': {
        domain: 'health',
        desc: 'Prompts for applying Australian health privacy regulations (APPs, state Health Records Acts) to agent decisions.',
        affects: 'Consent Check Agent d Health Data Sharing Agents',
        instructions: 'Ensure all agent decisions about viewing or sharing clinical data comply with Australian Privacy Principles and state health records law. Only use data for justified care, payment, or operations purposes.',
        policies: [
          'Apply Australian health privacy regulations (APP 6/11, state Health Records Acts) to all use of clinical and billing data.',
          'Limit use and disclosure of patient-identifiable data to the minimum necessary for the specific care, payment, or operations purpose.',
          'Do not use patient data from this environment for model training or analytics without explicit consent and governance approval.',
        ].join('\n- '),
        contextHint: 'Use privacy regulations, consent models, and integration constraints as context for this pack.',
        contextPrefixes: ['specs/health/privacy', 'constraints/health/privacy'],
      },
      'Patient Discharge Process': {
        domain: 'health',
        desc: 'Prompts for safe, policy-aligned patient discharge planning and follow-up.',
        affects: 'Discharge Agent d Agentic Referral Agent d Transport Booking Agent',
        instructions: 'At discharge, ensure suicide risk and other high-risk flags are reviewed; never complete discharge when risk is high and no safety plan exists. Schedule appropriate follow-up, community referrals, and transport as required.',
        policies: [
          'For Patient Discharge agents: confirm that any suicidal ideation or high-risk flags are acknowledged and escalated before discharge is considered complete.',
          'For Patient Discharge agents: ensure that a follow-up plan (appointments, community referrals, safety planning) is scheduled where clinically indicated.',
          'For Patient Discharge agents: never auto-complete discharge workflows when suicide risk is present and no safety plan is documented.',
        ].join('\n- '),
        contextHint: 'Use discharge process specs, risk assessment guidelines, and handover templates as context for this pack.',
        contextPrefixes: ['specs/health/discharge', 'integrations/health', 'constraints/health'],
      },
    };

    function applyDomainFilter(domain) {
      if (!packList) return;
      const buttons = packList.querySelectorAll('button[data-pack]');
      buttons.forEach(btn => {
        const d = btn.getAttribute('data-domain') || 'water';
        btn.parentElement.style.display = (d === domain) ? '' : 'none';
      });
    }

    window.__currentPackName = window.__currentPackName || null;

    function selectPack(name) {
      const meta = PACK_META[name];
      if (!meta) return;
      window.__currentPackName = name;
      if (packTitle) packTitle.textContent = name;
      if (packDesc) packDesc.textContent = meta.desc;
      if (packAffects) packAffects.textContent = meta.affects;
      if (packInstructions) packInstructions.value = meta.instructions;
      if (policyText) policyText.value = '- ' + meta.policies;
      if (ctxPackHint) ctxPackHint.textContent = meta.contextHint || '';
      showToast('Selected: ' + name);
      // Re-render context list according to the selected pack, if already loaded
      renderContextList();
    }

    if (packList) {
      packList.addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-pack]');
        if (!btn) return;
        const name = btn.getAttribute('data-pack');
        selectPack(name);
      });
    }

    if (studioDomain) {
      studioDomain.addEventListener('change', () => {
        const domain = studioDomain.value || 'water';
        applyDomainFilter(domain);
        // Pick a default pack for this domain
        const firstBtn = packList && packList.querySelector(`button[data-domain="${domain}"]`);
        if (firstBtn) selectPack(firstBtn.getAttribute('data-pack'));
      });
      // Initial domain + pack
      const initialDomain = studioDomain.value || 'water';
      applyDomainFilter(initialDomain);
      const firstBtn = packList && packList.querySelector(`button[data-domain="${initialDomain}"]`);
      if (firstBtn) selectPack(firstBtn.getAttribute('data-pack'));
    }

    // Add Example modal
    function openAddExample() { openModal('addExampleModal'); }

    // Eval seeding based on source navigation
    function seedEval(source) {
      const sub = document.getElementById('evalSubtext');
      if (!sub) return;
      if (source === 'pack') {
        sub.textContent = 'Prompt Pack: ' + (window.__currentPackName || 'Health Agents') + '  Proposed v1.0.0';
      } else if (source === 'propose-pack') {
        sub.textContent = 'Proposed Deployment  ' + (window.__currentPackName || 'Health Agents');
      }
    }

    // Health Eval & Rollout context configuration
    const EVAL_CONTEXT_META = {
      discharge: {
        label: 'Patient Discharge',
        subtext: 'Health Agents  Patient Discharge  Proposed Prompt Version v1.0.0',
        metricsHtml: `
          <div class="card">
            <strong>Before (v1.0.0)</strong><br />
            Unsafe discharge decisions (suicide risk): 6.3%<br />
            Missed follow-up appointments: 18%<br />
            Readmission within 7 days: 11
          </div>
          <div class="card">
            <strong>After (v1.1.0  Test Run)</strong><br />
            Unsafe discharge decisions (suicide risk): 1.2%<br />
            Missed follow-up appointments: 10%<br />
            Readmission within 7 days: 6
          </div>
          <div class="card">
            <strong>Confidence</strong><br />
            Eval coverage: 92% of discharge scenarios<br />
            Critical regressions: 0<br />
            Policy breaches (suicide + no plan): 0
          </div>
          <div class="card">
            <strong>Notes</strong><br />
            Improved handling of high-risk patients with no safety plan.<br />
            Added checks that handover includes community referrals and follow-up.
          </div>
        `,
        suitesHtml: `
          <tr><td>High-Risk Discharge Scenarios</td><td></td><td>24 / 24</td><td>No unsafe discharges when suicide risk present and no plan.</td></tr>
          <tr><td>Standard Discharge Scenarios</td><td></td><td>60 / 60</td><td>Improved follow-up scheduling and documentation.</td></tr>
          <tr><td>Readmission Prevention Scenarios</td><td></td><td>18 / 18</td><td>Better recognition of recent admissions.</td></tr>
        `,
      },
      agentic: {
        label: 'Agentic Referral (LLM plan)',
        subtext: 'Health Agents  Agentic Referral (LLM plan)  Proposed Prompt Version v1.0.0',
        metricsHtml: `
          <div class="card">
            <strong>Before (v1.0.0)</strong><br />
            Correct risk triage: 81%<br />
            Referrals missing key handover info: 22%<br />
            Manual escalations from referral team: 14%
          </div>
          <div class="card">
            <strong>After (v1.1.0  Test Run)</strong><br />
            Correct risk triage: 93%<br />
            Referrals missing key handover info: 6%<br />
            Manual escalations from referral team: 9%
          </div>
          <div class="card">
            <strong>Confidence</strong><br />
            Eval coverage: 88% of referral scenarios<br />
            Critical regressions: 0<br />
            Policy breaches (privacy / consent): 0
          </div>
          <div class="card">
            <strong>Notes</strong><br />
            Agentic planner now incorporates submitted discharge/privacy policies.<br />
            Better separation of GP vs community mental health referrals.
          </div>
        `,
        suitesHtml: `
          <tr><td>Risk-Aware Referral Scenarios</td><td></td><td>32 / 32</td><td>Correct channel chosen for high-risk patients.</td></tr>
          <tr><td>Privacy-Constrained Referral Scenarios</td><td></td><td>20 / 20</td><td>No sharing beyond consented purposes.</td></tr>
          <tr><td>Low-Risk Routine Referrals</td><td></td><td>28 / 28</td><td>Stable behaviour; no regressions.</td></tr>
        `,
      },
      consent: {
        label: 'Consent Check',
        subtext: 'Health Agents  Consent Check  Proposed Prompt Version v1.0.0',
        metricsHtml: `
          <div class="card">
            <strong>Before (v1.0.0)</strong><br />
            Correct allow/deny decisions: 89%<br />
            Over-sharing events detected: 6<br />
            Under-sharing (blocked but allowed): 11
          </div>
          <div class="card">
            <strong>After (v1.1.0  Test Run)</strong><br />
            Correct allow/deny decisions: 97%<br />
            Over-sharing events detected: 0<br />
            Under-sharing (blocked but allowed): 5
          </div>
          <div class="card">
            <strong>Confidence</strong><br />
            Eval coverage: 90% of consent scenarios<br />
            Critical regressions: 0<br />
            Policy breaches (Australian health privacy): 0
          </div>
          <div class="card">
            <strong>Notes</strong><br />
            Updated prompts aligned with Australian Health Privacy Regulations pack.<br />
            Better handling of emergency vs routine access requests.
          </div>
        `,
        suitesHtml: `
          <tr><td>Treatment vs Operations Scenarios</td><td></td><td>26 / 26</td><td>Correctly distinguishes treatment and operations purposes.</td></tr>
          <tr><td>Third-Party Disclosure Scenarios</td><td></td><td>18 / 18</td><td>No inappropriate sharing with non-care entities.</td></tr>
          <tr><td>Emergency Access Scenarios</td><td></td><td>12 / 12</td><td>Correct emergency overrides applied.</td></tr>
        `,
      },
      travel: {
        label: 'Travel (Uber Booking)',
        subtext: 'Health Agents  Travel (Uber Booking)  Proposed Prompt Version v1.0.0',
        metricsHtml: `
          <div class="card">
            <strong>Before (v1.0.0)</strong><br />
            Correct pickup/dropoff selection: 88%<br />
            Late or missed pickups: 9%<br />
            Incorrect clinical priority tagging: 7%
          </div>
          <div class="card">
            <strong>After (v1.1.0  Test Run)</strong><br />
            Correct pickup/dropoff selection: 96%<br />
            Late or missed pickups: 4%<br />
            Incorrect clinical priority tagging: 2%
          </div>
          <div class="card">
            <strong>Confidence</strong><br />
            Eval coverage: 80% of discharge and appointment transport cases<br />
            Critical regressions: 0<br />
            Policy breaches (safety / escort requirements): 0
          </div>
          <div class="card">
            <strong>Notes</strong><br />
            Better alignment of transport booking with discharge and referral context.<br />
            Adds checks for escort requirements for high-risk patients.
          </div>
        `,
        suitesHtml: `
          <tr><td>Discharge Transport Scenarios</td><td></td><td>22 / 22</td><td>Correct handling of pickup, dropoff, and escort requirements.</td></tr>
          <tr><td>Outpatient Appointment Transport</td><td></td><td>30 / 30</td><td>On-time arrival and correct location selection.</td></tr>
          <tr><td>Edge-Case Routing Scenarios</td><td></td><td>10 / 10</td><td>Graceful handling of unavailable services.</td></tr>
        `,
      },
    };

    function applyEvalContext(key) {
      const meta = EVAL_CONTEXT_META[key] || EVAL_CONTEXT_META.discharge;
      const sub = document.getElementById('evalSubtext');
      const metrics = document.getElementById('evalMetrics');
      const suitesBody = document.getElementById('evalSuitesBody');
      if (sub) sub.textContent = meta.subtext;
      if (metrics) metrics.innerHTML = meta.metricsHtml;
      if (suitesBody) suitesBody.innerHTML = meta.suitesHtml;
    }

    // Deploy action
    function deploy() {
      const strat = document.getElementById('rolloutStrategy').value;
      const region = document.getElementById('rolloutRegion').value;
      showToast('Deployment scheduled: Version v1.8.0 → Prod (' + strat + ') for ' + region + '.');
    }

    // =====================
    // Context management UI
    // =====================
    async function loadContextList() {
      try {
        const res = await fetch((HEALTH_API.baseUrl||'') + '/context/list');
        const data = await res.json();
        const items = (data && data.items) || [];
        window.__ctxItems = items;
        renderContextList();
      } catch(e) {
        showToast('Failed to load context list');
      }
    }

    function renderContextList() {
      const listEl = document.getElementById('ctxList');
      if (!listEl) return;
      listEl.innerHTML = '';
      const allItems = window.__ctxItems || [];
      if (!allItems.length) { listEl.textContent = 'No context files found'; return; }

      const name = window.__currentPackName;
      const meta = name ? PACK_META[name] : null;
      const prefixes = (meta && meta.contextPrefixes) || null;

      let items = allItems.slice();
      items.sort((a,b)=> a.path.localeCompare(b.path));
      if (prefixes && prefixes.length) {
        items = items.filter(it => prefixes.some(pref => it.path.startsWith(pref)));
        if (!items.length) {
          // Fall back to all items if no matches for this pack
          items = allItems.slice().sort((a,b)=> a.path.localeCompare(b.path));
        }
      }

      items.forEach(it => {
        const btn = document.createElement('button');
        btn.className = 'btn';
        btn.style.display = 'block';
        btn.style.width = '100%';
        btn.style.textAlign = 'left';
        btn.style.marginBottom = '6px';
        btn.textContent = it.path;
        btn.addEventListener('click', ()=> previewContext(it.path));
        listEl.appendChild(btn);
      });
      // Auto-preview first item for this filtered view
      if (items[0]) previewContext(items[0].path);
      updateCtxExistingFileOptions();
    }

    function highlightSACSF(text) {
      if (!text) return '';
      // Highlight tokens like SACSF-XXX and headings
      let html = text
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;');
      html = html.replace(/(SACSF-[A-Z]{2}-?\d+)/g, '<span class="hl">$1<\/span>');
      html = html.replace(/(^- \*\*SACSF[^\n]*\*\*)/gm, '<span class="hl">$1<\/span>');
      return html;
    }

    async function previewContext(path) {
      try {
        const res = await fetch((HEALTH_API.baseUrl||'') + '/context/file?' + new URLSearchParams({ path }));
        if (!res.ok) { showToast('Failed to load ' + path); return; }
        const data = await res.json();
        const title = document.getElementById('ctxTitle');
        const prev = document.getElementById('ctxPreview');
        if (title) title.textContent = 'Preview • ' + path;
        if (prev) prev.innerHTML = highlightSACSF(data.content || '');
      } catch (e) {
        showToast('Error loading context file');
      }
    }

    async function addContextFile() {
      const dir = (document.getElementById('ctxDir')?.value || '').trim();
      const file = (document.getElementById('ctxFile')?.value || '').trim();
      const content = document.getElementById('ctxContent')?.value || '';
      if (!dir || !file) { showToast('Choose a folder and enter a filename'); return; }
      const path = dir + '/' + file.replace(/^\/+/, '');
      try {
        const res = await fetch((HEALTH_API.baseUrl||'') + '/context/add', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ path, content })
        });
        const data = await res.json().catch(()=>({}));
        if (!res.ok || !data.ok) { showToast('Failed to add file'); return; }
        showToast('Context file added');
        loadContextList();
      } catch(e) {
        showToast('Error adding file');
      }
    }

    async function uploadContextFiles() {
      const dir = (document.getElementById('ctxDir')?.value || '').trim();
      const input = document.getElementById('ctxUpload');
      if (!dir) { showToast('Choose a folder first'); return; }
      if (!input || !input.files || !input.files.length) { showToast('Select one or more files'); return; }

      const files = Array.from(input.files);
      for (const f of files) {
        try {
          const text = await f.text();
          const path = dir + '/' + f.name.replace(/^\/+/, '');
          const res = await fetch((HEALTH_API.baseUrl||'') + '/context/add', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ path, content: text })
          });
          const data = await res.json().catch(()=>({}));
          if (!res.ok || !data.ok) {
            showToast('Failed to add ' + f.name);
            continue;
          }
        } catch (e) {
          showToast('Error uploading ' + f.name);
        }
      }
      showToast('Context files uploaded');
      loadContextList();
    }

    function loadGenAIHub() {
      const iframe = document.getElementById('genai_hub_iframe');
      if (!iframe) return;
      iframe.src = 'https://dxc-genai-hub-app.politedesert-4176ca70.australiaeast.azurecontainerapps.io/?code=1.AQ0AcTXzkw9Vz0Own80zEzjQhvvo71E4061Oj9msH9M92JwNAGINAA.AgABBAIAAABlMNzVhAPUTrARzfQjWPtKAwDs_wUA9P9CISUpc3ksY-bqMEKJj32sGdqtDK1oTdnyVy3gjKmWz8P_9JPZj-HR9q509PGFfSOpKwL2zrJcRe-TjaT0S7g77DmCpbhoxIMQ72995aAXkj02D4-FCWDSwhwqFwS_V17e86rplMIrR4RpUiDO12ehHecIQylna1FQ5zL2Xl8N1ZkgwfvLr8DHaOQybehtcgAuAc_emrat6vDD2dTNCvz4xDzqb9yTUQFhIYA7hxLEMTjmgdtpXTqxV6DC7B2kUyxegdVc2ewEOzemoQD8QCNJmzdV2k2E6ixhzX1GovQKTfWw65an8hj0em4d-SNfbIJFSCwzivRVT9Vcrogxblium5QEXhNY0CpPtQNDGXDC-fKJGqaq45WkqHVzgHj5M7z5B0U2FLCoLXkT5RJ7JFlpA1Aq-MF4Hh_rPDDGbmbf3B1aNEBUAQu70N1Z7dWwrmxkKcJP5etST8YTB0dkJOwlFGyk8FY8l35Ykf47HaAf3YQVnkUY_uCuoZmdACwGqJP4MLoK9NhEkOpRpYfEvYUnUnDHT_ekFf7dOXXUJdg8pfzvhAnf6bYULN0y49mKBuxvGolMZUmTv2JXySqCLMWjLgc_GK272FQ_Y53CGnJEO0y2YTuiANVL1UQe4oq5VyS9FoEFMuXqRZBbeIX7eiH-SpgQWSLDR8LzhMc2O88j2hdtPXfzQr6ivQskbuWWokwyq9QnrQY5TO3NKfNpcX2EpZ4tdPcD8H6AJkIof1iU1tyglT7_xY8ucV0w3mjGqS3ELEztnWGGPleb34UXBnQvry9e6OINZfDd7l5R1-xhsHmnQ5o4zFbREdKRU7fMqnQ_btBjwB1bMtUwO593O7PIr-jvkbeiFhuapvatKl4ygRMAlqaOxkWN_QmAkzFzPY1&session_state=00aaede9-d758-7e93-f0a0-e6eb241acb18';
      showToast('Loading GenAI Hub…');
    }

    function updateCtxExistingFileOptions() {
      const dir = (document.getElementById('ctxDir')?.value || '').trim();
      const selEl = document.getElementById('ctxExistingFile');
      const items = window.__ctxItems || [];
      if (!selEl) return;

      selEl.innerHTML = '';
      const placeholder = document.createElement('option');
      placeholder.value = '';
      placeholder.textContent = dir ? 'Select file…' : 'Select folder first';
      selEl.appendChild(placeholder);

      if (!dir) return;
      const prefix = dir + '/';
      items
        .filter(it => typeof it.path === 'string' && it.path.startsWith(prefix))
        .forEach(it => {
          const opt = document.createElement('option');
          opt.value = it.path;
          // Show just the filename relative to the folder
          opt.textContent = it.path.slice(prefix.length);
          selEl.appendChild(opt);
        });
    }

    const ctxDirEl = document.getElementById('ctxDir');
    if (ctxDirEl) {
      ctxDirEl.addEventListener('change', () => {
        updateCtxExistingFileOptions();
      });
    }

    const ctxExistingEl = document.getElementById('ctxExistingFile');
    if (ctxExistingEl) {
      ctxExistingEl.addEventListener('change', async () => {
        const path = ctxExistingEl.value;
        if (!path) return;
        previewContext(path);
        // Also pre-fill manual edit fields
        const fileName = path.split('/').slice(1).join('/') || path;
        const fileInput = document.getElementById('ctxFile');
        if (fileInput) fileInput.value = fileName;
      });
    }

    // Initialise Hospital Discharge panel and Prompt Studio on load
    try { if (typeof renderHdPanel === 'function') renderHdPanel(); } catch (e) { console.error('renderHdPanel init failed', e); }
    try { if (typeof initPromptStudio === 'function') initPromptStudio(); } catch (e) { console.error('initPromptStudio init failed', e); }
  </script>
</body>
</html>
